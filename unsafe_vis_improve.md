# Unsafe/FFI 内存分析可视化优化方案 (v2.0)

## 1. 核心问题诊断：从“信息展示”到“问题沟通”

当前的可视化设计（v1.0）在美学和技术实现上非常出色，但其核心问题在于**认知负荷过高**。它平等地展示了所有内存块的生命周期，导致关键问题（如内存泄漏）被淹没在海量正常信息中。用户需要主动、费力地去“找问题”，而不是被工具“告知问题”。

**优化目标：** 将工具从一个**“数据展示面板”**升级为一个**“问题诊断导航仪”**。核心思路是**聚焦重点、强化视觉语言、激活深度交互**。

## 2. 优化方案详情

### 层面一：战略聚焦 (Focus on What Matters)

这是解决信息“嘈杂”问题的根本，也是本次迭代的最高优先级。

#### 2.1. 默认视图 = 问题视图 (Problem-First View)

- **现状:** 默认展示全部（例如 42 个）内存块的生命周期，好坏混杂。
- **改进:** 仪表盘加载后，**默认只渲染被判定为“泄漏 (Leaked)”或“高风险 (High-Risk)”的生命周期路径**。
- **UI 呈现:**
  - 高亮显示问题路径。
  - 所有“健康”的路径可以被隐藏，或以极低的饱和度（例如 20% 透明度的灰色）作为背景，避免视觉干扰。
- **收益:** 用户打开报告的**第一秒**，视线就将牢牢锁定在真正需要关注的问题上。诊断起点无比清晰。

#### 2.2. 引入交互式过滤器 (Interactive Filtering)

- **现状:** 用户无法按需筛选，只能被动接受所有信息。
- **改进:** 在“跨界泳道图”的标题旁边，增加一组 **Segmented Control (分段控件)** 或筛选按钮。
- **UI 设计:**
  - `[ ❗ 泄漏与风险 (4) ]` - (默认选中)
  - `[ 🔗 FFI 追踪 (32) ]`
  - `[ 🦀 Unsafe Rust 分配 ]`
  - `[ ⚙️ FFI C 分配 ]`
  - `[ ✨ 全部显示 (42) ]`
- **收益:** 将探索的主动权交还给用户，支持从不同角度、层层递进地进行分析。

#### 2.3. 聚合健康路径 (Aggregation of Healthy Paths)

- **现状:** 大量相似的、无问题的路径占据了宝贵的视觉空间。
- **改进:** 在“问题视图”下，将所有健康的路径聚合成一条摘要信息。
- **UI 设计:**
  - 在图表底部或侧边栏显示一行文字：“*另外 38 个内存块被正确管理，点击此处展开...*”
- **收益:** 极大简化了主视图，让复杂和异常的路径模式（如多次跨界、生命周期极长）能够脱颖而出。

---

### 层面二：视觉语言强化 (Enhanced Visual Language)

优化图形元素的视觉编码，让用户“看一眼”就能理解信息，而不是“读一遍”。

#### 2.1. 区分“主线”与“事件线” (Differentiate Lifecycle Path vs. Event Line)

- **现状:** 水平和垂直的虚线样式过于接近，主次不分。
- **改进:**
  - **生命周期主线 (水平方向):** 改为**加粗的实线 (Bold, Solid Line)**。它是每个内存块故事的“脊梁”。
  - **跨界事件线 (垂直方向):** 保持为**细虚线 (Thin, Dashed Line)**。它代表状态的“跳变”。
- **收益:** 视觉层次感立刻显现，用户可以毫不费力地顺着实线追溯一个内存块的完整生命周期。

#### 2.2. 用“路径颜色”直接反映最终状态 (Path Color Reflects Final Status)

- **现状:** 用户需要追踪到路径尽头才能判断其状态。
- **改进:** 让**生命周期主线（加粗实线）的颜色直接反映内存块的最终状态**。
- **颜色编码:**
  - **`<span style="color:red;">`红色实线:** 表示**泄漏 (Leaked)** 的路径。
  - **`<span style="color:green;">`绿色实线:** 表示**正确释放 (Freed Correctly)** 的路径。
  - **`<span style="color:yellow;">`黄色实线:** 表示**存在潜在风险 (Potential Risk)** 的路径（例如，`malloc` 的内存没有通过 `Box::from_raw` 管理，或生命周期异常长）。
- **收益:** **颠覆性的体验提升！** 用户现在只需扫一眼，就能通过颜色立即识别出所有问题内存块。顶部的 KPI `4 泄漏` 将与图中的 4 条红色主线完美对应。

#### 2.3. 让路径“跟随”责任域 (Path Follows Responsibility)

- **现状:** C/FFI 域基本为空，所有路径都在 Rust 域，不符合“所有权流转”的直觉。
- **改进:** 当一个指针通过 `RustToFfi` ▼ 事件进入 C 域后，它的**生命周期主线也应该在 C/FFI 泳道中继续延伸**，直到它通过 `FfiToRust` ▲ 事件返回 Rust 域。
- **收益:** 真正实现了“泳道”的意义。用户可以清晰地看到一个内存块在哪个时间段是由 C 代码“持有”和负责的，可视化与内存管理的内在逻辑完全统一。

![优化后泳道图概念](https://storage.googleapis.com/gemini-prod/images/swimlane_improved_v2.png)
*(概念图：展示了默认聚焦问题（红色泄漏路径）、路径颜色反映状态、路径跟随泳道等改进)*

---

### 层面三：激活深度交互 (Activate Deep Interaction)

将静态的图表转变为一个可供探索的动态分析工具。

#### 3.1. 实现“发现 -> 分析”的完整诊断闭环

- **现状:** 缺乏从宏观到微观的流畅交互。
- **改进:**
  1. **悬浮预览 (Hover for Preview):** 鼠标悬浮在任何节点或路径上时，显示一个**轻量级工具提示 (Tooltip)**，包含指针地址、大小、状态等核心信息。
  2. **点击深入 (Click for Deep-Dive):** 当用户**点击**任何一个节点或路径时，在侧边栏或以模态框 (Modal) 的形式，弹出我们之前设计的完整的**“内存护照”**信息卡片。
- **收益:** 实现了从“**发现问题**（看到红色路径）”到“**定位细节**（悬浮预览）”再到“**深度分析**（点击查看护照）”的完整诊断流程。

#### 3.2. 提供时空探索能力

- **现状:** 整个时间轴一览无余，难以聚焦局部。
- **改进:**
  - **时间轴刷选 (Timeline Brushing):** 让底部的时间轴支持“刷选”功能。用户可以用鼠标在时间轴上拖拽出一个范围，主视图的泳道图将**动态缩放**，只显示该时间范围内的事件。
  - **平移与缩放 (Pan & Zoom):** 为泳道图区域本身增加平移和滚轮缩放功能。
- **收益:** 提供了强大的时空探索能力，尤其是在事件非常密集的复杂场景下。

## 4. 迭代优先级建议

建议按以下顺序进行迭代，以实现最大化的价值提升：

1. **P0 (核心体验重塑):**

   - ✅ **默认只显示泄漏/风险路径。**
   - ✅ **用路径颜色（红/绿/黄）直接反映最终状态。**
   - ✅ **区分主线（实线）和事件线（虚线）。**
   - ✅ **实现点击路径弹出“内存护照”的详细信息。**
2. **P1 (易用性与逻辑增强):**

   - ✅ 添加交互式过滤器。
   - ✅ 让路径跟随责任域进入对应的泳道。
3. **P2 (高级功能与锦上添花):**

   - ✅ 聚合健康路径。
   - ✅ 实现时间轴刷选和平移缩放。

通过以上改进，您的 Unsafe/FFI 分析模块将从一个“美观的数据陈列馆”蜕变为一个“**精准、高效、直观的内存安全审计平台**”，为 Rust 开发者提供无与伦比的洞察力。
