<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MemScope Memory Analysis Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    {{CSS_CONTENT}}
    
    /* Clean, high-contrast layout variables */
    :root {
      --primary-blue: #2563eb;
      --primary-green: #059669;
      --primary-red: #dc2626;
      --primary-orange: #ea580c;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --border-light: #e5e7eb;
      --shadow-light: 0 1px 3px 0 rgb(0 0 0 / 0.1);
    }
    
    .dark {
      --text-primary: #f9fafb;
      --text-secondary: #d1d5db;
      --bg-primary: #111827;
      --bg-secondary: #1f2937;
      --border-light: #374151;
      --shadow-light: 0 4px 6px -1px rgb(0 0 0 / 0.3);
    }
    
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.3s ease;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }
    
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
      min-height: 100vh;
    }
    
    /* 顶部标题栏 */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding: 20px 0;
      border-bottom: 1px solid var(--border-light);
    }
    
    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }
    
    .header .subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 4px;
    }
    
    /* 主题切换按钮 */
    .theme-toggle {
      background: var(--primary-blue);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .theme-toggle:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }
    
    /* 卡片样式 */
    .card {
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow-light);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px -5px rgb(0 0 0 / 0.1);
    }
    
    .card h2 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 16px 0;
      border-bottom: 2px solid var(--primary-blue);
      padding-bottom: 8px;
    }
    
    /* 网格布局 */
    .grid {
      display: grid;
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    
    /* KPI 指标卡片 */
    .kpi-card {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary-blue) 0%, #3b82f6 100%);
      color: white;
      border-radius: 12px;
      border: none;
      box-shadow: var(--shadow-light);
    }
    
    .kpi-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .kpi-label {
      font-size: 0.875rem;
      opacity: 0.9;
      font-weight: 500;
    }
    
    /* 图表容器 */
    .chart-container {
      height: 300px;
      background: var(--bg-primary);
      border-radius: 8px;
      position: relative;
      padding: 16px;
    }
    
    /* 表格样式 */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }
    
    th {
      background: var(--bg-secondary);
      font-weight: 600;
      color: var(--text-primary);
    }
    
    tr:hover {
      background: var(--bg-secondary);
    }
    
    @media (max-width: 768px) {
      .grid-2, .grid-3, .grid-4 {
        grid-template-columns: 1fr;
      }
      
      .dashboard-container {
        padding: 16px;
      }
      
      .header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
    }
    
    .scroll {
      max-height: 400px;
      overflow: auto;
    }
    
    .scroll::-webkit-scrollbar {
      width: 6px;
    }
    
    .scroll::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }
    
    .scroll::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 3px;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status-active { background: #dcfce7; color: #166534; }
    .status-leaked { background: #fee2e2; color: #dc2626; }
    .status-freed { background: #e5e7eb; color: #374151; }
    
    .dark .status-active { background: #064e3b; color: #34d399; }
    .dark .status-leaked { background: #7f1d1d; color: #fca5a5; }
    .dark .status-freed { background: #374151; color: #d1d5db; }
    
    .risk-low { background: #dcfce7; color: #166534; }
    .risk-medium { background: #fef3c7; color: #92400e; }
    .risk-high { background: #fee2e2; color: #dc2626; }
    
    .dark .risk-low { background: #064e3b; color: #34d399; }
    .dark .risk-medium { background: #78350f; color: #fbbf24; }
    .dark .risk-high { background: #7f1d1d; color: #fca5a5; }
    
    /* Enhanced Lifecycle Visualization Styles */
    .allocation-type {
      padding: 3px 6px;
      border-radius: 3px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
    }

    .type-heap { 
      background: #fef3c7; 
      color: #92400e; 
      border: 1px solid #f59e0b;
    }
    
    .type-stack { 
      background: #dbeafe; 
      color: #1e40af; 
      border: 1px solid #3b82f6;
    }
    
    .type-unknown { 
      background: #f3f4f6; 
      color: #6b7280; 
      border: 1px solid #9ca3af;
    }

    .dark .type-heap { 
      background: #78350f; 
      color: #fbbf24; 
    }
    
    .dark .type-stack { 
      background: #1e3a8a; 
      color: #60a5fa; 
    }
    
    .dark .type-unknown { 
      background: #374151; 
      color: #d1d5db; 
    }

    /* Enhanced progress bar animations */
    @keyframes shine {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: 100%; }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Enhanced lifecycle item styles */
    .lifecycle-item.heap {
      border-left-color: #ff6b35 !important;
    }

    .lifecycle-item.stack {
      border-left-color: #4dabf7 !important;
    }

    .lifecycle-item:hover {
      animation: pulse 1s ease-in-out;
    }

    .lifecycle-bar {
      height: 16px;
      background: var(--bg-secondary);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      margin: 6px 0;
      border: 1px solid var(--border-light);
    }

    .lifecycle-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-green), var(--primary-blue));
      border-radius: 7px;
      position: relative;
      transition: width 0.3s ease;
    }

    .lifecycle-item {
      margin: 8px 0;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border-left: 4px solid var(--primary-blue);
      transition: all 0.2s ease;
    }

    .lifecycle-item:hover {
      background: var(--bg-primary);
      box-shadow: var(--shadow-light);
    }

    .lifecycle-item.heap {
      border-left-color: var(--primary-orange);
    }

    .lifecycle-item.stack {
      border-left-color: var(--primary-blue);
    }

    .time-info {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 6px;
      font-family: 'Courier New', monospace;
    }

    .time-badge {
      display: inline-block;
      padding: 2px 6px;
      background: var(--bg-primary);
      border-radius: 3px;
      margin-right: 8px;
      border: 1px solid var(--border-light);
    }
  </style>
  <script>
    // Data injection placeholder - will be replaced by build tool
    window.analysisData = {{ json_data }};
    
    // Emergency fallback: Load data directly from JSON files if injection failed
    if (!window.analysisData || Object.keys(window.analysisData).length === 0 || 
        !window.analysisData.memory_analysis || !window.analysisData.memory_analysis.allocations) {
      
      console.warn('Data injection failed, attempting to load from JSON files...');
      
      // Try to fetch the JSON data directly
      fetch('./large_scale_user_memory_analysis.json')
        .then(response => response.json())
        .then(memoryData => {
          console.log('✅ Loaded memory analysis data:', memoryData);
          
          // Construct the expected data structure
          window.analysisData = {
            memory_analysis: memoryData,
            lifetime: {},
            complex_types: {},
            unsafe_ffi: {},
            performance: {}
          };
          
          // Try to load other JSON files
          Promise.all([
            fetch('./large_scale_user_lifetime.json').then(r => r.json()).catch(() => ({})),
            fetch('./large_scale_user_complex_types.json').then(r => r.json()).catch(() => ({})),
            fetch('./large_scale_user_unsafe_ffi.json').then(r => r.json()).catch(() => ({})),
            fetch('./large_scale_user_performance.json').then(r => r.json()).catch(() => ({}))
          ]).then(([lifetime, complexTypes, unsafeFfi, performance]) => {
            window.analysisData.lifetime = lifetime;
            window.analysisData.complex_types = complexTypes;
            window.analysisData.unsafe_ffi = unsafeFfi;
            window.analysisData.performance = performance;
            
            console.log('✅ All data loaded, initializing enhanced features...');
            
            // Trigger enhanced features initialization
            console.log('🚀 Triggering enhanced features initialization...');
            if (typeof initEnhancedLifecycleVisualization === 'function') {
              setTimeout(() => {
                console.log('🔄 Calling initEnhancedLifecycleVisualization...');
                initEnhancedLifecycleVisualization();
              }, 100);
            } else {
              console.error('❌ initEnhancedLifecycleVisualization function not found');
            }
            
            // Also trigger the main dashboard initialization if needed
            if (typeof initDashboard === 'function') {
              setTimeout(() => {
                console.log('🔄 Calling initDashboard...');
                initDashboard();
              }, 200);
            }
          });
        })
        .catch(error => {
          console.error('❌ Failed to load JSON data:', error);
          
          // Last resort: Create dummy data for testing
          window.analysisData = {
            memory_analysis: {
              allocations: [
                {
                  var_name: 'test_var_1',
                  type_name: 'Arc<String>',
                  size: 1024,
                  timestamp_alloc: Date.now() * 1000000,
                  lifetime_ms: 100.5,
                  is_leaked: false
                },
                {
                  var_name: 'test_var_2', 
                  type_name: 'Vec<i32>',
                  size: 2048,
                  timestamp_alloc: Date.now() * 1000000 + 1000000,
                  lifetime_ms: 250.0,
                  is_leaked: true
                }
              ]
            }
          };
          console.log('⚠️ Using dummy data for testing');
        });
    } else {
      console.log('✅ Data injection successful');
    }
    
    console.log('Final analysisData:', window.analysisData);
    console.log('Allocations available:', window.analysisData?.memory_analysis?.allocations?.length || 0);
  </script>
</head>
<body>
  <div class="dashboard-container">
    <!-- Header -->
    <header class="header">
      <div>
        <h1>MemScope Memory Analysis Dashboard</h1>
        <div class="subtitle">Real-time Rust Memory Usage Monitoring</div>
      </div>
      <button id="theme-toggle" class="theme-toggle">
        <i class="fa fa-moon"></i>
        <span>Toggle Theme</span>
      </button>
    </header>

    <!-- KPI Metrics -->
    <section class="grid grid-4">
      <div class="kpi-card">
        <div class="kpi-value" id="total-allocations">-</div>
        <div class="kpi-label">Total Allocations</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="active-variables">-</div>
        <div class="kpi-label">Active Variables</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="total-memory">-</div>
        <div class="kpi-label">Total Memory</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="safety-score">-</div>
        <div class="kpi-label">Safety Score</div>
      </div>
    </section>

    <!-- Key Performance Metrics (high priority position) -->
    <section class="grid grid-2">
      <div class="card">
        <h2><i class="fa fa-tachometer-alt"></i> Performance Metrics</h2>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
          <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-blue);" id="peak-memory">0B</div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">Peak Memory</div>
          </div>
          <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-green);" id="allocation-rate">0/sec</div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">Allocation Rate</div>
          </div>
          <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-orange);" id="avg-lifetime">0ms</div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">Avg Lifetime</div>
          </div>
          <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-red);" id="fragmentation">0%</div>
            <div style="font-size: 0.8rem; color: var(--text-secondary);">Fragmentation</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h2><i class="fa fa-shield-alt"></i> Thread Safety Analysis</h2>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary-blue);" id="arc-count">0</div>
            <div style="font-size: 0.7rem; color: var(--text-secondary);">Arc</div>
          </div>
          <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary-green);" id="rc-count">0</div>
            <div style="font-size: 0.7rem; color: var(--text-secondary);">Rc</div>
          </div>
          <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary-orange);" id="collections-count">0</div>
            <div style="font-size: 0.7rem; color: var(--text-secondary);">Collections</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Charts -->
    <section class="grid grid-2">
      <div class="card">
        <h2>Memory by Type</h2>
        <div class="chart-container">
          <canvas id="typeChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h2>Memory Over Time</h2>
        <div class="chart-container">
          <canvas id="timelineChart"></canvas>
        </div>
        <div style="margin-top:8px; font-size:12px; color: var(--text-secondary); display:flex; gap:8px; align-items:center;">
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input id="toggleGrowthRate" type="checkbox" style="accent-color: var(--primary-green)">
            <span>Show Growth Rate</span>
          </label>
          <span style="opacity:0.8">Left Y: Cumulative memory, Right Y: Growth rate</span>
        </div>
      </div>
    </section>

    <!-- Memory Analysis (wider layout) -->
    <section class="grid grid-2">
      <div class="card">
        <h2>Type Treemap</h2>
        <div id="treemap" class="chart-container" style="height: 360px; padding: 0; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 8px; overflow: hidden;"></div>
      </div>
      <div class="card">
        <h2><i class="fa fa-timeline"></i> Variable Lifecycle Visualization</h2>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="display: flex; gap: 6px;">
            <button id="filter-heap" class="theme-toggle" style="background: var(--primary-orange); font-size: 10px; padding: 3px 6px;">
              <span>Heap</span>
            </button>
            <button id="filter-stack" class="theme-toggle" style="background: var(--primary-blue); font-size: 10px; padding: 3px 6px;">
              <span>Stack</span>
            </button>
            <button id="toggle-lifecycle" class="theme-toggle" style="background: var(--primary-green); font-size: 10px; padding: 3px 6px;">
              <span>All</span>
            </button>
          </div>
          <div style="display: flex; gap: 12px; font-size: 0.75rem; color: var(--text-secondary);">
            <span>Heap: <span id="heap-count-mini" style="color: var(--primary-orange); font-weight: 600;">-</span></span>
            <span>Stack: <span id="stack-count-mini" style="color: var(--primary-blue); font-weight: 600;">-</span></span>
          </div>
        </div>
        <div style="margin-bottom: 8px;">
          <button id="manual-init-btn" style="background: var(--primary-red); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
            🔄 Manual Initialize
          </button>
          <span id="init-status" style="margin-left: 8px; font-size: 0.8rem; color: var(--text-secondary);">Waiting for data...</span>
        </div>
        <div id="lifecycleVisualizationContainer" class="scroll" style="max-height: 320px; padding: 8px;">
          <!-- Variable lifecycle items will be inserted here -->
        </div>
      </div>
    </section>

    <!-- Advanced Analysis -->
    <section class="grid grid-2">
      <div class="card">
        <h2>Memory Fragmentation</h2>
        <div id="memoryFragmentation"></div>
      </div>
      <div class="card">
        <h2><i class="fa fa-fire"></i> Borrow Activity Heatmap</h2>
        <div id="borrowPatternChart" style="height: 200px;"></div>
      </div>
    </section>

    <!-- Allocation Timeline (Full Width) -->
    <section class="card">
      <h2><i class="fa fa-history"></i> Allocation Timeline</h2>
      <div id="allocationTimelineDetail" style="height: 200px; padding: 8px; background: var(--bg-secondary); border-radius: 8px; overflow-y: auto;">
        <div style="text-align: center; color: var(--text-secondary); margin-top: 80px;">Loading timeline...</div>
      </div>
    </section>

    <!-- Timeline Insights & Memory Operations (2x2 Grid) -->
    <section class="grid grid-2">
      <div class="card">
        <h2><i class="fa fa-clock-o"></i> Timeline Insights</h2>
        <div id="timelineInsights" style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="margin-bottom: 12px;">
            <span style="color: var(--text-secondary); font-size: 0.9rem;">Time Span:</span>
            <span id="time-span" style="color: var(--text-primary); font-weight: 600; margin-left: 8px;">-</span>
          </div>
          <div style="margin-bottom: 12px;">
            <span style="color: var(--text-secondary); font-size: 0.9rem;">Allocation Burst:</span>
            <span id="allocation-burst" style="color: var(--text-primary); font-weight: 600; margin-left: 8px;">-</span>
          </div>
          <div style="margin-bottom: 12px;">
            <span style="color: var(--text-secondary); font-size: 0.9rem;">Peak Concurrency:</span>
            <span id="peak-concurrency" style="color: var(--text-primary); font-weight: 600; margin-left: 8px;">-</span>
          </div>
          <div>
            <span style="color: var(--text-secondary); font-size: 0.9rem;">Thread Activity:</span>
            <span id="thread-activity" style="color: var(--text-primary); font-weight: 600; margin-left: 8px;">-</span>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h2><i class="fa fa-exchange"></i> Memory Operations</h2>
        <div id="memoryOperations" style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="text-align: center; padding: 12px; background: var(--bg-primary); border-radius: 6px;">
              <div id="borrow-ops" style="font-size: 1.4rem; font-weight: 700; color: var(--primary-blue);">-</div>
              <div style="font-size: 0.7rem; color: var(--text-secondary);">Borrow Ops</div>
            </div>
            <div style="text-align: center; padding: 12px; background: var(--bg-primary); border-radius: 6px;">
              <div id="clone-ops" style="font-size: 1.4rem; font-weight: 700; color: var(--primary-orange);">-</div>
              <div style="font-size: 0.7rem; color: var(--text-secondary);">Clone Ops</div>
            </div>
            <div style="text-align: center; padding: 12px; background: var(--bg-primary); border-radius: 6px;">
              <div id="mut-ratio" style="font-size: 1.4rem; font-weight: 700; color: var(--primary-red);">-</div>
              <div style="font-size: 0.7rem; color: var(--text-secondary);">Mut/Immut</div>
            </div>
            <div style="text-align: center; padding: 12px; background: var(--bg-primary); border-radius: 6px;">
              <div id="avg-borrows" style="font-size: 1.4rem; font-weight: 700; color: var(--primary-green);">-</div>
              <div style="font-size: 0.7rem; color: var(--text-secondary);">Avg/Alloc</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Type Memory Blocks & Enhanced Statistics -->
    <section class="grid grid-2">
      <div class="card">
        <h2><i class="fa fa-cubes"></i> Type Memory Blocks</h2>
        <div id="memoryDistributionChart" style="height: 200px; overflow-y: auto;"></div>
      </div>
      
      <div class="card">
        <h2><i class="fa fa-info-circle"></i> Enhanced Memory Statistics</h2>
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="text-align: center; padding: 12px; background: var(--bg-primary); border-radius: 6px;">
              <div id="total-allocs-enhanced" style="font-size: 1.2rem; font-weight: 700; color: var(--primary-blue);">-</div>
              <div style="font-size: 0.7rem; color: var(--text-secondary);">Total Allocs</div>
            </div>
            <div style="text-align: center; padding: 12px; background: var(--bg-primary); border-radius: 6px;">
              <div id="heap-stack-ratio" style="font-size: 1.2rem; font-weight: 700; color: var(--primary-orange);">-</div>
              <div style="font-size: 0.7rem; color: var(--text-secondary);">Heap/Stack</div>
            </div>
            <div style="text-align: center; padding: 12px; background: var(--bg-primary); border-radius: 6px;">
              <div id="avg-lifetime-enhanced" style="font-size: 1.2rem; font-weight: 700; color: var(--primary-green);">-</div>
              <div style="font-size: 0.7rem; color: var(--text-secondary);">Avg Lifetime</div>
            </div>
            <div style="text-align: center; padding: 12px; background: var(--bg-primary); border-radius: 6px;">
              <div id="memory-efficiency" style="font-size: 1.2rem; font-weight: 700; color: var(--primary-purple);">-</div>
              <div style="font-size: 0.7rem; color: var(--text-secondary);">Efficiency</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Variable Relationships Graph -->
    <section class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="margin: 0;">Variable Relationships</h2>
        <div>
          <button id="reset-zoom" class="theme-toggle" style="background: var(--primary-orange); font-size: 12px; padding: 6px 12px; margin-right: 8px;">
            <i class="fa fa-expand"></i>
            <span>Reset View</span>
          </button>
          <button id="auto-layout" class="theme-toggle" style="background: var(--primary-green); font-size: 12px; padding: 6px 12px;">
            <i class="fa fa-magic"></i>
            <span>Auto Layout</span>
          </button>
        </div>
      </div>
      <div id="graph" style="height: 400px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 8px; position: relative; overflow: hidden;"></div>
    </section>

    <!-- Memory Hotspots & Thread Analysis -->
    <section class="grid grid-2">
      <div class="card">
        <h2><i class="fa fa-bolt"></i> Memory Hotspots</h2>
        <div id="memoryHotspots" style="height: 300px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; overflow-y: auto;">
          <div style="text-align: center; color: var(--text-secondary); margin-top: 100px;">
            Loading memory hotspots...
          </div>
        </div>
      </div>
      
      <div class="card">
        <h2><i class="fa fa-users"></i> Thread & Concurrency</h2>
        <div id="threadAnalysis" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; height: 300px;">
          <div style="display: grid; grid-template-rows: 1fr 1fr; gap: 12px; height: 100%;">
            <!-- Thread Activity -->
            <div style="background: var(--bg-primary); padding: 12px; border-radius: 6px;">
              <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 12px;">
                <i class="fa fa-clock-o"></i> Thread Activity
              </h4>
              <div id="threadTimeline" style="height: 60px; position: relative; border: 1px solid var(--border-light); border-radius: 4px; background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);"></div>
            </div>
            
            <!-- Memory Contention -->
            <div style="background: var(--bg-primary); padding: 12px; border-radius: 6px;">
              <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 12px;">
                <i class="fa fa-warning"></i> Memory Contention
              </h4>
              <div style="display: flex; align-items: center; justify-content: center; height: 60px;">
                <div style="text-align: center;">
                  <div id="contention-level" style="font-size: 1.5rem; font-weight: 700; color: var(--primary-green);">LOW</div>
                  <div style="font-size: 0.7rem; color: var(--text-secondary);" id="contention-details">Single-threaded</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>


    <!-- Data Tables -->
    <section class="grid grid-2">
      <div class="card">
        <h2>Memory Allocation Details</h2>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Variable</th>
                <th>Type</th>
                <th>Size</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="allocTable"></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h2>Safety Risk Items</h2>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Location</th>
                <th>Operation</th>
                <th>Risk Level</th>
              </tr>
            </thead>
            <tbody id="unsafeTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Unsafe/FFI Analysis (Unified Background Container) -->
    <section style="background: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-light); min-height: 800px;">
      <h2 style="margin: 0 0 20px 0; color: var(--text-primary);">Unsafe Rust & FFI Memory Analysis</h2>
      <div id="ffiVisualization" class="chart-container" style="width: 100%;">
        <div style="background: var(--bg-primary); border-radius:8px; padding:16px; text-align:center; color: var(--text-secondary);">
          <i class="fa fa-info-circle" style="font-size:24px; margin-bottom:8px; opacity:0.5;"></i>
          <div>Loading FFI analysis...</div>
        </div>
      </div>
    </section>

  </div>

  <script>
    // Enhanced Lifecycle Visualization Functions
    function inferAllocationType(typeName) {
      if (!typeName) return 'unknown';
      
      const heapTypes = ['Box', 'Vec', 'String', 'HashMap', 'BTreeMap', 'Arc', 'Rc', 'alloc::', 'std::collections'];
      const stackTypes = ['i32', 'i64', 'f32', 'f64', 'bool', 'char', 'usize', 'isize', 'u8', 'u16', 'u32', 'u64'];
      
      for (const heapType of heapTypes) {
        if (typeName.includes(heapType)) return 'heap';
      }
      
      for (const stackType of stackTypes) {
        if (typeName.includes(stackType)) return 'stack';
      }
      
      if (typeName.includes('*') || typeName.includes('&')) return 'heap';
      
      return 'unknown';
    }

    function formatTimestamp(timestamp) {
      if (!timestamp || isNaN(timestamp)) return 'N/A';
      const date = new Date(timestamp / 1000000); // Convert nanoseconds to milliseconds
      if (isNaN(date.getTime())) return 'N/A';
      return date.toLocaleTimeString() + '.' + String(date.getMilliseconds()).padStart(3, '0');
    }

    function calculateDropTime(allocTime, lifetimeMs) {
      if (!allocTime || lifetimeMs === undefined || isNaN(allocTime) || isNaN(lifetimeMs)) return null;
      return allocTime + (lifetimeMs * 1000000); // Convert ms to nanoseconds and add
    }

    function formatLifetime(lifetimeMs) {
      if (lifetimeMs === undefined || lifetimeMs === null) return 'N/A';
      if (lifetimeMs < 1) return `${(lifetimeMs * 1000).toFixed(1)}μs`;
      if (lifetimeMs < 1000) return `${lifetimeMs.toFixed(1)}ms`;
      return `${(lifetimeMs / 1000).toFixed(2)}s`;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function initEnhancedLifecycleVisualization() {
      // Debug what's available
      console.log('Checking data availability...');
      console.log('window.analysisData exists:', !!window.analysisData);
      console.log('window.analysisData type:', typeof window.analysisData);
      
      if (window.analysisData) {
        console.log('window.analysisData keys:', Object.keys(window.analysisData));
      }
      
      // Try multiple data structure paths
      let allocations = null;
      
      if (window.analysisData) {
        // Method 1: Direct allocations (old structure)
        if (window.analysisData.allocations && Array.isArray(window.analysisData.allocations)) {
          allocations = window.analysisData.allocations;
          console.log('✅ Found allocations directly:', allocations.length);
        }
        // Method 2: Memory analysis structure (new structure)
        else if (window.analysisData.memory_analysis && window.analysisData.memory_analysis.allocations) {
          allocations = window.analysisData.memory_analysis.allocations;
          console.log('✅ Found allocations in memory_analysis:', allocations.length);
        }
        // Method 3: Check all keys for allocations
        else {
          for (const [key, value] of Object.entries(window.analysisData)) {
            if (value && typeof value === 'object' && value.allocations && Array.isArray(value.allocations)) {
              allocations = value.allocations;
              console.log('✅ Found allocations in', key + ':', allocations.length);
              break;
            }
          }
        }
      }
      
      if (!allocations || !Array.isArray(allocations) || allocations.length === 0) {
        console.warn('No allocation data found in window.analysisData');
        
        // Fallback: Try to get data from other global variables that might be set by the dashboard
        if (typeof getAllocations === 'function') {
          try {
            allocations = getAllocations();
            console.log('✅ Got allocations from getAllocations():', allocations.length);
          } catch (e) {
            console.warn('getAllocations() failed:', e);
          }
        }
        
        // Another fallback: Check if data is in a different global variable
        if (!allocations && window.memoryAnalysisData) {
          if (window.memoryAnalysisData.allocations) {
            allocations = window.memoryAnalysisData.allocations;
            console.log('✅ Got allocations from memoryAnalysisData:', allocations.length);
          }
        }
        
        // Final fallback: Try to extract from existing DOM elements
        if (!allocations) {
          const existingTable = document.getElementById('allocTable');
          if (existingTable && existingTable.children.length > 1) {
            console.log('Trying to extract data from existing table...');
            // This is a last resort - we'll create dummy data based on table rows
            const rows = existingTable.querySelectorAll('tbody tr');
            if (rows.length > 0) {
              allocations = Array.from(rows).map((row, index) => {
                const cells = row.querySelectorAll('td');
                return {
                  var_name: cells[0]?.textContent || `var_${index}`,
                  type_name: cells[1]?.textContent || 'unknown',
                  size: parseInt(cells[2]?.textContent) || 0,
                  timestamp_alloc: Date.now() * 1000000 + index * 1000000,
                  lifetime_ms: parseFloat(cells[3]?.textContent) || 1.0,
                  is_leaked: cells[4]?.textContent?.includes('Yes') || false
                };
              });
              console.log('✅ Extracted', allocations.length, 'allocations from existing table');
            }
          }
        }
        
        if (!allocations || allocations.length === 0) {
          console.error('❌ No allocation data available from any source');
          return;
        }
      }
      
      if (allocations.length === 0) {
        console.warn('No allocation data found');
        return;
      }

      console.log('✅ Found', allocations.length, 'allocations for enhanced visualization');
      console.log('Sample allocation:', allocations[0]);
      
      // Statistics
      let heapCount = 0, stackCount = 0, unknownCount = 0;
      let totalLifetime = 0, validLifetimes = 0;
      let totalMemory = 0;

      allocations.forEach(alloc => {
        const type = inferAllocationType(alloc.type_name);
        if (type === 'heap') heapCount++;
        else if (type === 'stack') stackCount++;
        else unknownCount++;

        if (alloc.lifetime_ms !== undefined && alloc.lifetime_ms !== null) {
          totalLifetime += alloc.lifetime_ms;
          validLifetimes++;
        }

        totalMemory += alloc.size || 0;
      });

      console.log('Statistics calculated:', { heapCount, stackCount, totalLifetime, validLifetimes });

      // Update mini counters
      const heapCountMini = document.getElementById('heap-count-mini');
      const stackCountMini = document.getElementById('stack-count-mini');
      
      if (heapCountMini) {
        heapCountMini.textContent = heapCount;
        console.log('Updated heap-count-mini:', heapCount);
      } else {
        console.warn('heap-count-mini element not found');
      }
      
      if (stackCountMini) {
        stackCountMini.textContent = stackCount;
        console.log('Updated stack-count-mini:', stackCount);
      } else {
        console.warn('stack-count-mini element not found');
      }
      
      // Create lifecycle visualization
      console.log('Calling createLifecycleVisualization...');
      createLifecycleVisualization(allocations);
      
      // Update enhanced statistics
      console.log('Calling updateEnhancedStatistics...');
      updateEnhancedStatistics(allocations, heapCount, stackCount, validLifetimes, totalLifetime);
      
      // Setup filters
      console.log('Calling setupLifecycleFilters...');
      setupLifecycleFilters(allocations);
      
      console.log('✅ All enhanced features processing completed');
    }

    function createLifecycleVisualization(allocations) {
      console.log('createLifecycleVisualization called with', allocations.length, 'allocations');
      const container = document.getElementById('lifecycleVisualizationContainer');
      if (!container) {
        console.error('❌ Lifecycle visualization container not found in DOM');
        return;
      }
      console.log('✅ Found lifecycleVisualizationContainer, creating visualization...');
      container.innerHTML = '';

      // Calculate timeline bounds
      const timestamps = allocations.map(a => a.timestamp_alloc).filter(t => t);
      const minTime = Math.min(...timestamps);
      const maxTime = Math.max(...timestamps);
      const timeRange = maxTime - minTime || 1;

      allocations.forEach((alloc, index) => {
        const allocType = inferAllocationType(alloc.type_name);
        const startTime = alloc.timestamp_alloc || alloc.timestamp || Date.now() * 1000000;
        const lifetime = alloc.lifetime_ms || alloc.lifetime || 0;
        const endTime = startTime + (lifetime * 1000000); // Convert ms to nanoseconds
        
        // Debug and validate time data
        console.log('Debug allocation:', {
          var_name: alloc.var_name,
          timestamp_alloc: alloc.timestamp_alloc,
          timestamp: alloc.timestamp,
          lifetime_ms: alloc.lifetime_ms,
          startTime: startTime,
          endTime: endTime,
          isValidStart: !isNaN(startTime) && startTime > 0,
          isValidEnd: !isNaN(endTime) && endTime > 0
        });
        
        // If timestamps are invalid, use relative positioning
        if (isNaN(startTime) || startTime <= 0) {
          startTime = minTime + (index * (timeRange / allocations.length));
        }
        if (isNaN(endTime) || endTime <= 0) {
          endTime = startTime + (lifetime * 1000000) || startTime + (timeRange * 0.1);
        }
        
        // Calculate positions and widths with bounds checking
        let startPercent = ((startTime - minTime) / timeRange) * 100;
        let endPercent = ((endTime - minTime) / timeRange) * 100;
        
        // Ensure values are within bounds
        startPercent = Math.max(0, Math.min(startPercent, 100));
        endPercent = Math.max(startPercent, Math.min(endPercent, 100));
        
        let width = endPercent - startPercent;
        width = Math.max(width, 2); // Minimum 2% width
        width = Math.min(width, 100 - startPercent); // Don't exceed container
        
        // Create lifecycle item
        const item = document.createElement('div');
        item.className = `lifecycle-item ${allocType}`;
        item.setAttribute('data-type', allocType);
        
        // Enhanced solid colors for better visibility
        const barColor = allocType === 'heap' ? '#ff6b35' : 
                        allocType === 'stack' ? '#4dabf7' : '#868e96';
        const barGradient = allocType === 'heap' ? '#ff6b35' : 
                           allocType === 'stack' ? '#4dabf7' : 
                           '#868e96';
        
        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-weight: 600; font-size: 0.9rem; min-width: 120px;">${alloc.var_name || 'unnamed'}</span>
              <span class="allocation-type type-${allocType}">${allocType}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: var(--text-secondary);">
              <span>${formatBytes(alloc.size || 0)}</span>
              <span>${formatLifetime(lifetime)}</span>
            </div>
          </div>
          
          <!-- Enhanced Timeline Progress Bar -->
          <div style="position: relative; height: 24px; background: linear-gradient(90deg, #e8eaed, #ddd); border-radius: 12px; margin: 10px 0; border: 1px solid #bbb; box-shadow: inset 0 1px 2px rgba(0,0,0,0.08);">
            
            <!-- Variable active period with enhanced gradient -->
            <div style="position: absolute; top: 1px; left: ${startPercent}%; width: ${width}%; height: calc(100% - 2px); 
                        background: ${barGradient}; 
                        border-radius: 11px; 
                        box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.3);
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;">
              
              <!-- Animated shine effect -->
              <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; 
                          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
                          animation: shine 2s infinite;"></div>
            </div>
            
            ${alloc.is_leaked ? `
              <!-- Leaked indicator -->
              <div style="position: absolute; top: -3px; right: 2px; width: 20px; height: 30px; 
                          background: linear-gradient(45deg, #ff4757, #ff3742); 
                          border-radius: 2px; 
                          box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                          display: flex; align-items: center; justify-content: center;
                          font-size: 10px; color: white; font-weight: bold;">⚠</div>
            ` : ''}
          </div>
          
          <!-- Time info -->
          <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-secondary); font-family: monospace;">
            <span>Start: ${formatTimestamp(startTime)}</span>
            <span>${alloc.is_leaked ? 'LEAKED' : (formatTimestamp(endTime) !== 'N/A' ? 'End: ' + formatTimestamp(endTime) : 'Active')}</span>
          </div>
        `;
        
        // Enhanced hover effect and styling
        item.style.cssText += `
          margin-bottom: 18px;
          padding: 16px;
          background: linear-gradient(135deg, var(--bg-primary), #fafbfc);
          border-radius: 12px;
          border-left: 5px solid ${barColor};
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        `;
        
        item.addEventListener('mouseenter', () => {
          item.style.transform = 'translateX(8px) translateY(-2px)';
          item.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
          item.style.background = `linear-gradient(135deg, var(--bg-primary), ${barColor}08)`;
        });
        
        item.addEventListener('mouseleave', () => {
          item.style.transform = 'translateX(0) translateY(0)';
          item.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
          item.style.background = 'linear-gradient(135deg, var(--bg-primary), #fafbfc)';
        });
        
        container.appendChild(item);
      });
    }

    function updateEnhancedStatistics(allocations, heapCount, stackCount, validLifetimes, totalLifetime) {
      console.log('Updating enhanced statistics...');
      
      // Update Enhanced Memory Statistics
      const totalAllocsEnhanced = document.getElementById('total-allocs-enhanced');
      const heapStackRatio = document.getElementById('heap-stack-ratio');
      const avgLifetimeEnhanced = document.getElementById('avg-lifetime-enhanced');
      const memoryEfficiency = document.getElementById('memory-efficiency');
      
      if (totalAllocsEnhanced) {
        totalAllocsEnhanced.textContent = allocations.length;
        console.log('Updated total-allocs-enhanced:', allocations.length);
      }
      
      if (heapStackRatio) {
        const ratio = stackCount > 0 ? (heapCount / stackCount).toFixed(1) : heapCount;
        heapStackRatio.textContent = ratio + ':1';
        console.log('Updated heap-stack-ratio:', ratio + ':1');
      }
      
      if (avgLifetimeEnhanced) {
        const avgLifetime = validLifetimes > 0 ? formatLifetime(totalLifetime / validLifetimes) : 'N/A';
        avgLifetimeEnhanced.textContent = avgLifetime;
        console.log('Updated avg-lifetime-enhanced:', avgLifetime);
      }
      
      if (memoryEfficiency) {
        const efficiency = allocations.length > 0 ? ((allocations.length - allocations.filter(a => a.is_leaked).length) / allocations.length * 100).toFixed(0) : 0;
        memoryEfficiency.textContent = efficiency + '%';
        console.log('Updated memory-efficiency:', efficiency + '%');
      }
    }


    function setupLifecycleFilters(allocations) {
      const heapBtn = document.getElementById('filter-heap');
      const stackBtn = document.getElementById('filter-stack');
      const allBtn = document.getElementById('toggle-lifecycle');
      
      // Check if all buttons exist
      if (!heapBtn || !stackBtn || !allBtn) {
        console.warn('Some filter buttons not found');
        return;
      }
      
      let currentFilter = 'all';
      
      function applyFilter(filter) {
        currentFilter = filter;
        const items = document.querySelectorAll('.lifecycle-item');
        
        // Update button states
        [heapBtn, stackBtn, allBtn].forEach(btn => btn.style.opacity = '0.6');
        
        if (filter === 'heap') {
          heapBtn.style.opacity = '1';
          items.forEach(item => {
            item.style.display = item.getAttribute('data-type') === 'heap' ? 'block' : 'none';
          });
        } else if (filter === 'stack') {
          stackBtn.style.opacity = '1';
          items.forEach(item => {
            item.style.display = item.getAttribute('data-type') === 'stack' ? 'block' : 'none';
          });
        } else {
          allBtn.style.opacity = '1';
          items.forEach(item => {
            item.style.display = 'block';
          });
        }
      }
      
      heapBtn.addEventListener('click', () => applyFilter('heap'));
      stackBtn.addEventListener('click', () => applyFilter('stack'));
      allBtn.addEventListener('click', () => applyFilter('all'));
      
      // Initialize
      applyFilter('all');
    }

    // Initialize enhanced features when DOM is loaded
    function initEnhancedFeatures() {
      try {
        initEnhancedLifecycleVisualization();
      } catch (error) {
        console.error('Error initializing enhanced lifecycle visualization:', error);
      }
    }

    // Safe initialization wrapper with duplicate prevention
    let enhancedInitialized = false;
    function safeInitEnhanced() {
      if (enhancedInitialized) {
        return; // Already initialized
      }
      
      try {
        initEnhancedFeatures();
        enhancedInitialized = true;
        console.log('✅ Enhanced features initialized successfully');
      } catch (error) {
        console.warn('Enhanced features initialization failed:', error);
      }
    }

    {{JS_CONTENT}}

    // Override problematic functions AFTER JS_CONTENT loads
    window.updateLifecycleStatistics = function() {
      // Safe override - prevent errors from missing DOM elements
      try {
        // Try to find and update elements safely
        const elements = ['active-vars', 'freed-vars', 'leaked-vars', 'avg-lifetime-stat'];
        elements.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = '-';
        });
      } catch (e) {
        // Silently ignore errors
      }
    };

    // Override other potential problem functions
    window.updateKPIMetrics = function() { return; };
    window.populateLifetimeTable = function() { return; };
    window.updateMemoryStats = function() { return; };

    // Manual initialization function for testing
    function manualInitialize() {
      const statusEl = document.getElementById('init-status');
      if (statusEl) statusEl.textContent = 'Initializing...';
      
      console.log('🔄 Manual initialization triggered');
      console.log('window.analysisData:', window.analysisData);
      
      if (window.analysisData && window.analysisData.memory_analysis && window.analysisData.memory_analysis.allocations) {
        console.log('✅ Data found, calling initEnhancedLifecycleVisualization...');
        initEnhancedLifecycleVisualization();
        if (statusEl) statusEl.textContent = 'Initialized successfully!';
      } else {
        console.warn('❌ No data found, trying to load...');
        if (statusEl) statusEl.textContent = 'Loading data...';
        
        // Try to load data manually
        fetch('./large_scale_user_memory_analysis.json')
          .then(response => response.json())
          .then(memoryData => {
            console.log('✅ Manually loaded data:', memoryData);
            window.analysisData = {
              memory_analysis: memoryData
            };
            initEnhancedLifecycleVisualization();
            if (statusEl) statusEl.textContent = 'Data loaded and initialized!';
          })
          .catch(error => {
            console.error('❌ Failed to load data:', error);
            if (statusEl) statusEl.textContent = 'Failed to load data';
          });
      }
    }

    // Wait for all scripts to load, then initialize
    function waitForDataAndInit() {
      if (window.analysisData && window.analysisData.memory_analysis && window.analysisData.memory_analysis.allocations) {
        safeInitEnhanced();
      } else {
        setTimeout(waitForDataAndInit, 200);
      }
    }
    
    // Initialize enhanced features after everything loads
    document.addEventListener('DOMContentLoaded', function() {
      // Setup manual initialize button
      const manualBtn = document.getElementById('manual-init-btn');
      if (manualBtn) {
        manualBtn.addEventListener('click', manualInitialize);
      }
      
      // Start checking for data immediately
      waitForDataAndInit();
    });
  </script>
</body>
</html>