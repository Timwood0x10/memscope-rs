<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory & FFI Snapshot Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        {{CSS_CONTENT}}
    </style>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        neutral: '#1F2937',
                        'neutral-light': '#F3F4F6',
                        'ffi-red': '#EF4444',
                        'safe-yellow': '#F59E0B',
                        'safe-green': '#10B981',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .hover-lift {
                transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            }
            .hover-lift:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }
            .graph-container {
                overflow: auto;
                border-radius: 0.5rem;
            }
            .timeline-item {
                position: relative;
            }
            .timeline-item::before {
                content: '';
                position: absolute;
                left: -29px;
                top: 5px;
                height: 15px;
                width: 15px;
                border-radius: 50%;
            }
            .timeline-line {
                position: absolute;
                left: -22px;
                top: 20px;
                bottom: -10px;
                width: 2px;
            }
            .lifespan-indicator {
                height: 4px;
                border-radius: 2px;
                margin: 2px 0;
                position: relative;
                overflow: hidden;
            }
            .lifespan-indicator::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                background-color: rgba(255,255,255,0.3);
                animation: flow 2s linear infinite;
            }
            @keyframes flow {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(100%); }
            }
            .collapsible-content {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease-out;
            }
            .collapsible-content.active {
                max-height: 2000px;
                transition: max-height 0.6s ease-in;
            }
            .rotate-icon {
                transition: transform 0.3s ease;
            }
            .rotate-icon.active {
                transform: rotate(180deg);
            }
            /* SVG Styles */
            .node-ffi {
                cursor: pointer;
                transition: all 0.3s ease;
            }
            .node-ffi rect {
                rx: 4;
                ry: 4;
                stroke-width: 2;
            }
            .node-ffi text {
                font-family: Arial, sans-serif;
                font-size: 12px;
            }
            .node-ffi:hover {
                filter: drop-shadow(0 3px 3px rgba(0,0,0,0.2));
            }
            .edge-ffi {
                stroke-width: 2;
                stroke-opacity: 0.7;
                transition: all 0.3s ease;
            }
            .edge-ffi:hover {
                stroke-opacity: 1;
                stroke-width: 2.5;
            }
            .tooltip-ffi {
                font-family: Arial, sans-serif;
                font-size: 12px;
                padding: 6px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 3px;
                pointer-events: none;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-neutral">
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-neutral">
                <i class="fa fa-microchip text-primary mr-3"></i>Memory & FFI Snapshot Analysis
            </h1>
            <p class="text-gray-500 mt-1">Complex Types, Lifetimes, Relationships & Unsafe Operations</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- Summary Section -->
        <section class="mb-12">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-bar-chart text-primary mr-2"></i>Analysis Summary
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-neutral-light rounded-lg p-4 hover-lift">
                        <p class="text-gray-500 text-sm">Total Complex Types</p>
                        <p class="text-3xl font-bold" id="total-complex-types">5</p>
                    </div>
                    <div class="bg-neutral-light rounded-lg p-4 hover-lift">
                        <p class="text-gray-500 text-sm">Allocations Analyzed</p>
                        <p class="text-3xl font-bold" id="total-allocations">639</p>
                    </div>
                    <div class="bg-neutral-light rounded-lg p-4 hover-lift">
                        <p class="text-gray-500 text-sm">Generic Types</p>
                        <p class="text-3xl font-bold" id="generic-type-count">6</p>
                    </div>
                    <div class="bg-neutral-light rounded-lg p-4 hover-lift border-l-4 border-ffi-red">
                        <p class="text-gray-500 text-sm">Unsafe FFI Entries</p>
                        <p class="text-3xl font-bold" id="unsafe-ffi-count">2</p>
                    </div>
                </div>
                
                <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-medium mb-3">Complexity Distribution</h3>
                        <div class="h-64">
                            <canvas id="complexity-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium mb-3">Memory Distribution by Type</h3>
                        <div class="h-64">
                            <canvas id="memory-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Variable Lifecycle Timeline -->
        <section class="mb-12">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-clock-o text-primary mr-2"></i>Variable Lifecycle Timeline
                </h2>
                <div class="overflow-x-auto">
                    <div class="min-w-[800px]">
                        <div class="flex items-end">
                            <!-- Timeline header with time markers -->
                            <div class="w-40 flex-shrink-0 font-medium">Variable</div>
                            <div class="flex-grow flex border-t border-gray-300 relative">
                                <div class="absolute top-0 left-0 w-full flex justify-between text-xs text-gray-500">
                                    <span>0ms</span>
                                    <span>250ms</span>
                                    <span>500ms</span>
                                    <span>750ms</span>
                                    <span>1000ms</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Vec Type -->
                        <div class="flex items-end py-3 border-b border-gray-100">
                            <div class="w-40 flex-shrink-0 text-sm">numbers_vec (Vec<i32>)</div>
                            <div class="flex-grow relative">
                                <div class="lifespan-indicator bg-blue-500" style="width: 80%;" title="Lifetime: 800ms">
                                    <div class="absolute -top-6 left-0 text-xs bg-blue-500 text-white px-2 py-1 rounded whitespace-nowrap">
                                        Allocated: 0ms
                                    </div>
                                    <div class="absolute -top-6 right-0 text-xs bg-blue-700 text-white px-2 py-1 rounded whitespace-nowrap">
                                        Deallocated: 800ms
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rc Types -->
                        <div class="flex items-end py-3 border-b border-gray-100">
                            <div class="w-40 flex-shrink-0 text-sm">rc_data (Rc<Vec<i32>>)</div>
                            <div class="flex-grow relative">
                                <div class="lifespan-indicator bg-yellow-500" style="width: 70%; margin-left: 10%;" title="Lifetime: 700ms">
                                    <div class="absolute -top-6 left-0 text-xs bg-yellow-500 text-white px-2 py-1 rounded whitespace-nowrap">
                                        Allocated: 100ms
                                    </div>
                                    <div class="absolute -top-6 right-0 text-xs bg-yellow-700 text-white px-2 py-1 rounded whitespace-nowrap">
                                        Deallocated: 800ms
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-end py-3 border-b border-gray-100">
                            <div class="w-40 flex-shrink-0 text-sm">rc_data_clone (Rc<Vec<i32>>)</div>
                            <div class="flex-grow relative">
                                <div class="lifespan-indicator bg-yellow-500" style="width: 50%; margin-left: 20%;" title="Lifetime: 500ms">
                                    <div class="absolute -top-6 left-0 text-xs bg-yellow-500 text-white px-2 py-1 rounded whitespace-nowrap">
                                        Cloned: 200ms
                                    </div>
                                    <div class="absolute -top-6 right-0 text-xs bg-yellow-700 text-white px-2 py-1 rounded whitespace-nowrap">
                                        Dropped: 700ms
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Arc Type -->
                        <div class="flex items-end py-3 border-b border-gray-100">
                            <div class="w-40 flex-shrink-0 text-sm">arc_data (Arc<String>)</div>
                            <div class="flex-grow relative">
                                <div class="lifespan-indicator bg-green-500" style="width: 60%; margin-left: 30%;" title="Lifetime: 600ms">
                                    <div class="absolute -top-6 left-0 text-xs bg-green-500 text-white px-2 py-1 rounded whitespace-nowrap">
                                        Allocated: 300ms
                                    </div>
                                    <div class="absolute -top-6 right-0 text-xs bg-green-700 text-white px-2 py-1 rounded whitespace-nowrap">
                                        Deallocated: 900ms
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Box Types -->
                        <div class="flex items-end py-3 border-b border-gray-100">
                            <div class="w-40 flex-shrink-0 text-sm">boxed_value (Box<i32>)</div>
                            <div class="flex-grow relative">
                                <div class="lifespan-indicator bg-purple-500" style="width: 40%; margin-left: 25%;" title="Lifetime: 400ms">
                                    <div class="absolute -top-6 left-0 text-xs bg-purple-500 text-white px-2 py-1 rounded whitespace-nowrap">
                                        Allocated: 250ms
                                    </div>
                                    <div class="absolute -top-6 right-0 text-xs bg-purple-700 text-white px-2 py-1 rounded whitespace-nowrap">
                                        Deallocated: 650ms
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-end py-3">
                            <div class="w-40 flex-shrink-0 text-sm">boxed_value2 (Box<i32>)</div>
                            <div class="flex-grow relative">
                                <div class="lifespan-indicator bg-purple-500" style="width: 30%; margin-left: 60%;" title="Lifetime: 300ms">
                                    <div class="absolute -top-6 left-0 text-xs bg-purple-500 text-white px-2 py-1 rounded whitespace-nowrap">
                                        Allocated: 600ms
                                    </div>
                                    <div class="absolute -top-6 right-0 text-xs bg-purple-700 text-white px-2 py-1 rounded whitespace-nowrap">
                                        Deallocated: 900ms
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-sm text-gray-500 italic">
                    <i class="fa fa-info-circle mr-1"></i>
                    Visual representation of variable lifetimes showing allocation/deallocation points and durations
                </div>
            </div>
        </section>

        <!-- Generic Types Table -->
        <section class="mb-12">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-table text-primary mr-2"></i>Generic Types Details
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variable Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pointer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size (bytes)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lifetime (ms)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Complexity</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="generic-types-table-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Variable Relationship Graph -->
        <section class="mb-12">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-sitemap text-primary mr-2"></i>Variable Relationship Graph
                </h2>
                <div class="mb-4 flex items-center space-x-4 flex-wrap">
                    <div class="flex items-center">
                        <span class="w-4 h-4 rounded-full bg-blue-500 mr-2"></span>
                        <span class="text-sm">Vec Types</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-4 h-4 rounded-full bg-green-500 mr-2"></span>
                        <span class="text-sm">Arc Types</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-4 h-4 rounded-full bg-purple-500 mr-2"></span>
                        <span class="text-sm">Box Types</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-4 h-4 rounded-full bg-yellow-500 mr-2"></span>
                        <span class="text-sm">Rc Types</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-4 h-4 rounded-full bg-pink-500 mr-2"></span>
                        <span class="text-sm">String Types</span>
                    </div>
                </div>
                <div class="border rounded-lg p-4 bg-neutral-light h-[500px] graph-container">
                    <!-- Variable Relationship SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 600" width="100%" height="100%">
                        <!-- Definitions -->
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                    refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                            </marker>
                            <marker id="dashed-arrow" markerWidth="10" markerHeight="7" 
                                    refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                            </marker>
                            
                            <!-- Gradients -->
                            <linearGradient id="vecGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:0.8" />
                                <stop offset="100%" style="stop-color:#3B82F6;stop-opacity:0.4" />
                            </linearGradient>
                            <linearGradient id="arcGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#10B981;stop-opacity:0.8" />
                                <stop offset="100%" style="stop-color:#10B981;stop-opacity:0.4" />
                            </linearGradient>
                            <linearGradient id="boxGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#8B5CF6;stop-opacity:0.8" />
                                <stop offset="100%" style="stop-color:#8B5CF6;stop-opacity:0.4" />
                            </linearGradient>
                            <linearGradient id="rcGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#F59E0B;stop-opacity:0.8" />
                                <stop offset="100%" style="stop-color:#F59E0B;stop-opacity:0.4" />
                            </linearGradient>
                            <linearGradient id="stringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#EC4899;stop-opacity:0.8" />
                                <stop offset="100%" style="stop-color:#EC4899;stop-opacity:0.4" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Background -->
                        <rect width="100%" height="100%" fill="#fafafa" />
                        <g id="var-zoom-container" transform="translate(0,0) scale(1)">
                            <!-- Subgraphs -->
                            <rect class="subgraph" x="100" y="50" width="300" height="150" fill="rgba(245,245,245,0.5)" stroke="#ccc" />
                            <text class="subgraph-label" x="250" y="70" text-anchor="middle" font-weight="bold">Data Containers</text>
                            
                            <rect class="subgraph" x="500" y="50" width="400" height="500" fill="rgba(245,245,245,0.5)" stroke="#ccc" />
                            <text class="subgraph-label" x="700" y="70" text-anchor="middle" font-weight="bold">Smart Pointers</text>
                            
                            <!-- Nodes -->
                            <g class="node-ffi" id="numbers_vec" data-type="Vec<i32>" data-size="20B" data-ptr="0x145005bd0" data-lifetime="800ms">
                                <rect x="150" y="100" width="200" height="60" fill="url(#vecGradient)" stroke="#3B82F6" />
                                <text x="250" y="125" text-anchor="middle" font-weight="bold">numbers_vec</text>
                                <text x="250" y="145" text-anchor="middle" font-size="12">Vec<i32></text>
                                <text x="250" y="165" text-anchor="middle" font-size="10" fill="#ffffff80">Lifetime: 800ms</text>
                            </g>
                            
                            <g class="node-ffi" id="vec_elements">
                                <rect x="150" y="200" width="200" height="40" fill="url(#vecGradient)" stroke="#3B82F6" />
                                <text x="250" y="225" text-anchor="middle">i32 elements</text>
                                <text x="250" y="240" text-anchor="middle" font-size="11">(dynamic array)</text>
                            </g>
                            
                            <g class="node-ffi" id="rc_data" data-type="Rc<Vec<i32>>" data-size="56B" data-ptr="0x5dd34c26" data-lifetime="700ms">
                                <rect x="550" y="100" width="200" height="60" fill="url(#rcGradient)" stroke="#F59E0B" />
                                <text x="650" y="125" text-anchor="middle" font-weight="bold">rc_data</text>
                                <text x="650" y="145" text-anchor="middle" font-size="12">Rc<Vec<i32>></text>
                                <text x="650" y="165" text-anchor="middle" font-size="10" fill="#ffffff80">Lifetime: 700ms</text>
                            </g>
                            
                            <g class="node-ffi" id="rc_data_clone" data-type="Rc<Vec<i32>>" data-size="56B" data-ptr="0x5dd34d06" data-lifetime="500ms">
                                <rect x="550" y="220" width="200" height="60" fill="url(#rcGradient)" stroke="#F59E0B" />
                                <text x="650" y="245" text-anchor="middle" font-weight="bold">rc_data_clone</text>
                                <text x="650" y="265" text-anchor="middle" font-size="12">Rc<Vec<i32>></text>
                                <text x="650" y="285" text-anchor="middle" font-size="10" fill="#ffffff80">Lifetime: 500ms</text>
                            </g>
                            
                            <g class="node-ffi" id="rc_count">
                                <rect x="780" y="140" width="100" height="40" fill="url(#rcGradient)" stroke="#F59E0B" />
                                <text x="830" y="165" text-anchor="middle">Ref count: 2</text>
                            </g>
                            
                            <g class="node-ffi" id="arc_data" data-type="Arc<String>" data-size="56B" data-ptr="0x6dd34c96" data-lifetime="600ms">
                                <rect x="550" y="340" width="200" height="60" fill="url(#arcGradient)" stroke="#10B981" />
                                <text x="650" y="365" text-anchor="middle" font-weight="bold">arc_data</text>
                                <text x="650" y="385" text-anchor="middle" font-size="12">Arc<String></text>
                                <text x="650" y="405" text-anchor="middle" font-size="10" fill="#ffffff80">Lifetime: 600ms</text>
                            </g>
                            
                            <g class="node-ffi" id="string_data" data-type="String" data-size="~19B" data-lifetime="600ms">
                                <rect x="550" y="460" width="200" height="40" fill="url(#stringGradient)" stroke="#EC4899" />
                                <text x="650" y="485" text-anchor="middle">String data</text>
                                <text x="650" y="505" text-anchor="middle" font-size="10" fill="#ffffff80">Lifetime: 600ms</text>
                            </g>
                            
                            <g class="node-ffi" id="arc_count">
                                <rect x="780" y="380" width="100" height="40" fill="url(#arcGradient)" stroke="#10B981" />
                                <text x="830" y="405" text-anchor="middle">Atomic count: 1</text>
                            </g>
                            
                            <g class="node-ffi" id="boxed_value" data-type="Box<i32>" data-size="4B" data-ptr="0x123e04720" data-lifetime="400ms">
                                <rect x="550" y="520" width="200" height="60" fill="url(#boxGradient)" stroke="#8B5CF6" />
                                <text x="650" y="545" text-anchor="middle" font-weight="bold">boxed_value</text>
                                <text x="650" y="565" text-anchor="middle" font-size="12">Box<i32></text>
                                <text x="650" y="585" text-anchor="middle" font-size="10" fill="#ffffff80">Lifetime: 400ms</text>
                            </g>
                            
                            <!-- Connections -->
                            <path class="edge-ffi" d="M250,160 L250,200" stroke="#3B82F6" marker-end="url(#arrowhead)" />
                            <text x="265" y="180" text-anchor="start" font-size="12">contains</text>
                            
                            <path class="edge-ffi" d="M550,130 L350,130" stroke="#F59E0B" marker-end="url(#arrowhead)" />
                            <text x="450" y="120" text-anchor="middle" font-size="12">points to</text>
                            
                            <path class="edge-ffi" d="M650,160 L650,220" stroke="#F59E0B" stroke-dasharray="5,3" marker-end="url(#dashed-arrow)" />
                            <text x="665" y="190" text-anchor="start" font-size="12">cloned to</text>
                            
                            <path class="edge-ffi" d="M750,130 L780,130 L780,160" stroke="#F59E0B" marker-end="url(#arrowhead)" />
                            <text x="765" y="120" text-anchor="middle" font-size="12">ref count</text>
                            
                            <path class="edge-ffi" d="M650,400 L650,460" stroke="#10B981" marker-end="url(#arrowhead)" />
                            <text x="665" y="430" text-anchor="start" font-size="12">points to</text>
                            
                            <path class="edge-ffi" d="M750,370 L780,370 L780,390" stroke="#10B981" marker-end="url(#arrowhead)" />
                            <text x="765" y="360" text-anchor="middle" font-size="12">atomic count</text>
                        </g>
                        
                        <!-- Tooltip -->
                        <g id="var-tooltip" class="tooltip-ffi" visibility="hidden">
                            <rect id="var-tooltip-bg" rx="3" ry="3" fill="white" />
                            <text id="var-tooltip-text" x="8" y="16"></text>
                        </g>
                    </svg>
                </div>
                <div class="mt-4 text-sm text-gray-500 italic">
                    <i class="fa fa-info-circle mr-1"></i>
                    Tip: Click and drag to pan, scroll to zoom, hover over nodes for details including lifetimes
                </div>
            </div>
        </section>

        <!-- Unsafe FFI Analysis Section -->
        <section class="mb-12">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-exclamation-triangle text-ffi-yellow mr-2"></i>Unsafe FFI Snapshot Analysis
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-ffi-red/10 rounded-lg p-5 border-l-4 border-ffi-red">
                        <h3 class="font-semibold text-lg mb-2">FFI Allocations</h3>
                        <p class="text-gray-700 mb-3">Total unsafe memory operations detected</p>
                        <div class="flex items-end">
                            <span class="text-4xl font-bold text-ffi-red">2</span>
                            <span class="text-gray-500 ml-2 mb-1">allocations</span>
                        </div>
                    </div>
                    
                    <div class="bg-ffi-yellow/10 rounded-lg p-5 border-l-4 border-ffi-yellow">
                        <h3 class="font-semibold text-lg mb-2">Risk Assessment</h3>
                        <p class="text-gray-700 mb-3">Overall safety evaluation</p>
                        <div class="flex items-end">
                            <span class="text-4xl font-bold text-ffi-yellow">Medium</span>
                            <span class="text-gray-500 ml-2 mb-1">risk level</span>
                        </div>
                    </div>
                    
                    <div class="bg-safe-green/10 rounded-lg p-5 border-l-4 border-safe-green">
                        <h3 class="font-semibold text-lg mb-2">Safety Violations</h3>
                        <p class="text-gray-700 mb-3">Detected safety issues</p>
                        <div class="flex items-end">
                            <span class="text-4xl font-bold text-safe-green">0</span>
                            <span class="text-gray-500 ml-2 mb-1">violations</span>
                        </div>
                    </div>
                </div>
                
                <!-- FFI Call Flow Visualization -->
                <div class="mb-8">
                    <h3 class="text-lg font-medium mb-4">FFI Call Flow Visualization</h3>
                    <div class="border rounded-lg p-4 bg-neutral-light h-[350px] graph-container">
                        <!-- FFI Call Flow SVG -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 300" width="100%" height="100%">
                            <!-- Definitions -->
                            <defs>
                                <marker id="ffi-arrowhead" markerWidth="10" markerHeight="7" 
                                        refX="9" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                                </marker>
                                <linearGradient id="rustGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#E57373;stop-opacity:0.8" />
                                    <stop offset="100%" style="stop-color:#E57373;stop-opacity:0.4" />
                                </linearGradient>
                                <linearGradient id="cGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#64B5F6;stop-opacity:0.8" />
                                    <stop offset="100%" style="stop-color:#64B5F6;stop-opacity:0.4" />
                                </linearGradient>
                                <linearGradient id="unsafeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#F57C00;stop-opacity:0.8" />
                                    <stop offset="100%" style="stop-color:#F57C00;stop-opacity:0.4" />
                                </linearGradient>
                            </defs>
                            
                            <!-- Background -->
                            <rect width="100%" height="100%" fill="#fafafa" />
                            
                            <!-- Timeline -->
                            <line x1="50" y1="150" x2="950" y2="150" stroke="#ccc" stroke-width="2" />
                            
                            <!-- Nodes -->
                            <g class="node-ffi" id="rust-main" data-info="Rust main thread">
                                <rect x="100" y="100" width="120" height="80" rx="4" fill="url(#rustGradient)" stroke="#E57373" />
                                <text x="160" y="130" text-anchor="middle" font-weight="bold">Rust</text>
                                <text x="160" y="150" text-anchor="middle">main thread</text>
                                <text x="160" y="170" text-anchor="middle" font-size="11">safe context</text>
                            </g>
                            
                            <g class="node-ffi" id="unsafe-block" data-info="Unsafe Rust block">
                                <rect x="300" y="100" width="140" height="80" rx="4" fill="url(#unsafeGradient)" stroke="#F57C00" />
                                <text x="370" y="130" text-anchor="middle" font-weight="bold">Unsafe Block</text>
                                <text x="370" y="150" text-anchor="middle">Rust code</text>
                                <text x="370" y="170" text-anchor="middle" font-size="11">unsafe context</text>
                            </g>
                            
                            <g class="node-ffi" id="libc" data-info="libc library">
                                <rect x="520" y="100" width="100" height="80" rx="4" fill="url(#cGradient)" stroke="#64B5F6" />
                                <text x="570" y="130" text-anchor="middle" font-weight="bold">libc</text>
                                <text x="570" y="150" text-anchor="middle">C library</text>
                                <text x="570" y="170" text-anchor="middle" font-size="11">malloc</text>
                            </g>
                            
                            <g class="node-ffi" id="ffi-return" data-info="Return to Rust">
                                <rect x="720" y="100" width="140" height="80" rx="4" fill="url(#rustGradient)" stroke="#E57373" />
                                <text x="790" y="130" text-anchor="middle" font-weight="bold">Rust</text>
                                <text x="790" y="150" text-anchor="middle">FFI boundary</text>
                                <text x="790" y="170" text-anchor="middle" font-size="11">data processing</text>
                            </g>
                            
                            <!-- Connections -->
                            <path class="edge-ffi" d="M220,140 L300,140" stroke="#F57C00" marker-end="url(#ffi-arrowhead)" />
                            <text x="260" y="130" text-anchor="middle" font-size="12">unsafe block entry</text>
                            
                            <path class="edge-ffi" d="M440,140 L520,140" stroke="#64B5F6" marker-end="url(#ffi-arrowhead)" />
                            <text x="480" y="130" text-anchor="middle" font-size="12">RustToFfi call</text>
                            
                            <path class="edge-ffi" d="M620,160 L720,160" stroke="#E57373" marker-end="url(#ffi-arrowhead)" />
                            <text x="670" y="170" text-anchor="middle" font-size="12">FfiToRust return</text>
                            
                            <!-- Memory allocation marker -->
                            <circle cx="570" cy="220" r="10" fill="#EF4444" stroke="#D32F2F" stroke-width="2" />
                            <text x="570" y="245" text-anchor="middle" font-size="12">256B allocation</text>
                            <line x1="570" y1="180" x2="570" y2="210" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                        </svg>
                    </div>
                </div>
                
                <!-- FFI Timeline -->
                <div class="mb-8">
                    <h3 class="text-lg font-medium mb-4">Timeline of Events</h3>
                    <div class="border rounded-lg p-6 bg-neutral-light relative pl-10">
                        <div class="timeline-line bg-gray-300"></div>
                        
                        <div class="timeline-item mb-6 pl-4" style="margin-left: 20px;">
                            <div class="before:bg-ffi-yellow timeline-item">
                                <h4 class="font-semibold text-ffi-yellow">Unsafe Rust Allocation</h4>
                                <p class="text-sm text-gray-600 mb-1">Timestamp: 1753414296355789000</p>
                                <p class="text-sm">Location: examples/unsafe_ffi_demo.rs:37:13</p>
                                <div class="mt-2 inline-block bg-ffi-yellow/10 text-ffi-yellow text-xs px-2 py-1 rounded">
                                    Manual Memory Management
                                </div>
                            </div>
                        </div>
                        
                        <div class="timeline-item mb-6 pl-4" style="margin-left: 20px;">
                            <div class="before:bg-ffi-red timeline-item">
                                <h4 class="font-semibold text-ffi-red">Rust to FFI Boundary Crossed</h4>
                                <p class="text-sm text-gray-600 mb-1">Timestamp: 1753414296355</p>
                                <p class="text-sm">From: unsafe_rust_block → To: potential_ffi_target</p>
                            </div>
                        </div>
                        
                        <div class="timeline-item mb-6 pl-4" style="margin-left: 20px;">
                            <div class="before:bg-blue-500 timeline-item">
                                <h4 class="font-semibold text-blue-500">libc malloc Called</h4>
                                <p class="text-sm text-gray-600 mb-1">Timestamp: 1753414296355925000</p>
                                <p class="text-sm">Allocated 256 bytes via libc</p>
                            </div>
                        </div>
                        
                        <div class="timeline-item pl-4" style="margin-left: 20px;">
                            <div class="before:bg-green-500 timeline-item">
                                <h4 class="font-semibold text-green-500">FFI to Rust Return</h4>
                                <p class="text-sm text-gray-600 mb-1">Timestamp: 1753414296356</p>
                                <p class="text-sm">From: libc → To: rust_main</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed FFI Data with collapsible sections -->
                <div>
                    <h3 class="text-lg font-medium mb-4">Detailed FFI Snapshot Data</h3>
                    <div id="ffi-data-render" class="space-y-6">
                        <!-- Will be populated by JavaScript with collapsible sections -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Optimization Recommendations -->
        <section>
            <div class="bg-white rounded-xl p-6 card-shadow">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-lightbulb-o text-primary mr-2"></i>Optimization Recommendations
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-medium text-lg mb-3">Memory Optimization</h3>
                        <ul class="list-disc pl-5 space-y-2" id="memory-optimization-recommendations">
                            <!-- Will be populated by JavaScript -->
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-medium text-lg mb-3">FFI Safety Improvements</h3>
                        <ul class="list-disc pl-5 space-y-2 text-ffi-red" id="ffi-optimization-recommendations">
                            <li>Replace manual memory management with RAII patterns</li>
                            <li>Add proper error handling around FFI boundaries</li>
                            <li>Consider using safer wrappers for libc functions</li>
                            <li>Implement proper memory cleanup for FFI allocations</li>
                            <li>Add validation for data crossing FFI boundaries</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-neutral text-white py-8 mt-12">
        <div class="container mx-auto px-4">
            <p class="text-center">Memory & FFI Snapshot Visualization Tool</p>
            <p class="text-center text-gray-400 text-sm mt-2">Generated from memory_analysis_snapshot.json</p>
        </div>
    </footer>

    <script>
        // Complex types data with lifetime information added
        const complexTypesData = {
            "categorized_types": {
                "collections": [],
                "generic_types": [
                    {
                        "complexity_score": 6,
                        "normalized_type": "alloc::vec::Vec<T>",
                        "ptr": "0x145005bd0",
                        "size": 20,
                        "type_name": "alloc::vec::Vec<i32>",
                        "var_name": "numbers_vec",
                        "lifetime_ms": 800
                    },
                    {
                        "complexity_score": 10,
                        "normalized_type": "alloc::sync::Arc<T>",
                        "ptr": "0x6dd34c96",
                        "size": 56,
                        "type_name": "alloc::sync::Arc<alloc::string::String>",
                        "var_name": "arc_data",
                        "lifetime_ms": 600
                    },
                    {
                        "complexity_score": 8,
                        "normalized_type": "alloc::boxed::Box<T>",
                        "ptr": "0x123e04720",
                        "size": 4,
                        "type_name": "alloc::boxed::Box<i32>",
                        "var_name": "boxed_value",
                        "lifetime_ms": 400
                    },
                    {
                        "complexity_score": 14,
                        "normalized_type": "alloc::rc::Rc<T>",
                        "ptr": "0x5dd34c26",
                        "size": 56,
                        "type_name": "alloc::rc::Rc<alloc::vec::Vec<i32>>",
                        "var_name": "rc_data",
                        "lifetime_ms": 700
                    },
                    {
                        "complexity_score": 14,
                        "normalized_type": "alloc::rc::Rc<T>",
                        "ptr": "0x5dd34d06",
                        "size": 56,
                        "type_name": "alloc::rc::Rc<alloc::vec::Vec<i32>>",
                        "var_name": "rc_data_clone",
                        "lifetime_ms": 500
                    },
                    {
                        "complexity_score": 8,
                        "normalized_type": "alloc::boxed::Box<T>",
                        "ptr": "0x123e05460",
                        "size": 4,
                        "type_name": "alloc::boxed::Box<i32>",
                        "var_name": "boxed_value2",
                        "lifetime_ms": 300
                    }
                ],
                "smart_pointers": [],
                "trait_objects": []
            },
            "complex_type_analysis": [
                {
                    "allocation_count": 2,
                    "average_size": 56,
                    "category": "Generic",
                    "complexity_score": 14,
                    "max_size": 56,
                    "memory_efficiency": 80,
                    "optimization_suggestions": [
                        "High complexity type - consider simplifying or using type aliases"
                    ],
                    "total_size": 112,
                    "type_name": "alloc::rc::Rc<T>"
                },
                {
                    "allocation_count": 1,
                    "average_size": 56,
                    "category": "Generic",
                    "complexity_score": 10,
                    "max_size": 56,
                    "memory_efficiency": 80,
                    "optimization_suggestions": [],
                    "total_size": 56,
                    "type_name": "alloc::sync::Arc<T>"
                },
                {
                    "allocation_count": 2,
                    "average_size": 4,
                    "category": "Generic",
                    "complexity_score": 8,
                    "max_size": 4,
                    "memory_efficiency": 90,
                    "optimization_suggestions": [],
                    "total_size": 8,
                    "type_name": "alloc::boxed::Box<T>"
                },
                {
                    "allocation_count": 1,
                    "average_size": 20,
                    "category": "Generic",
                    "complexity_score": 6,
                    "max_size": 20,
                    "memory_efficiency": 60,
                    "optimization_suggestions": [],
                    "total_size": 20,
                    "type_name": "alloc::vec::Vec<T>"
                },
                {
                    "allocation_count": 1,
                    "average_size": 19,
                    "category": "Simple",
                    "complexity_score": 1,
                    "max_size": 19,
                    "memory_efficiency": 85,
                    "optimization_suggestions": [],
                    "total_size": 19,
                    "type_name": "String"
                }
            ],
            "metadata": {
                "analysis_type": "complex_types_analysis_optimized",
                "export_version": "2.0",
                "optimization_level": "high",
                "processing_mode": "sequential",
                "timestamp": 1753328255,
                "total_allocations_analyzed": 639,
                "unique_complex_types": 5
            },
            "optimization_recommendations": [
                "Use 'cargo clippy' to identify additional optimization opportunities",
                "Consider profiling with 'perf' or 'valgrind' for detailed performance analysis",
                "Optimize Vec capacity to improve memory efficiency",
                "Use appropriate smart pointers based on concurrency requirements"
            ],
            "summary": {
                "collection_count": 0,
                "complexity_distribution": {
                    "high_complexity": 3,
                    "low_complexity": 1,
                    "medium_complexity": 1,
                    "very_high_complexity": 0
                },
                "generic_type_count": 6,
                "smart_pointer_count": 0,
                "total_complex_types": 5,
                "trait_object_count": 0
            }
        };

        // Unsafe FFI snapshot data
        const ffiSnapshotData = [
            {
                "base": {
                    "ptr": 5408595456,
                    "size": 256,
                    "var_name": null,
                    "type_name": null,
                    "scope_name": null,
                    "timestamp_alloc": 1753414296355925000,
                    "timestamp_dealloc": null,
                    "borrow_count": 0,
                    "stack_trace": null,
                    "is_leaked": false,
                    "lifetime_ms": null,
                    "smart_pointer_info": null,
                    "memory_layout": null,
                    "generic_info": null,
                    "dynamic_type_info": null,
                    "runtime_state": null,
                    "stack_allocation": null,
                    "temporary_object": null,
                    "fragmentation_analysis": null,
                    "generic_instantiation": null,
                    "type_relationships": null,
                    "type_usage": null,
                    "function_call_tracking": null,
                    "lifecycle_tracking": null,
                    "access_tracking": null
                },
                "source": {
                    "FfiC": {
                        "library_name": "libc",
                        "function_name": "malloc",
                        "call_stack": [
                            {
                                "function_name": "current_function",
                                "file_name": "src/unsafe_ffi_tracker.rs",
                                "line_number": 42,
                                "is_unsafe": true
                            }
                        ],
                        "libc_hook_info": {
                            "hook_method": "DynamicLinker",
                            "original_function": "malloc",
                            "hook_timestamp": 1753414296355937000,
                            "allocation_metadata": {
                                "requested_size": 256,
                                "actual_size": 256,
                                "alignment": 8,
                                "allocator_info": "libc malloc",
                                "protection_flags": {
                                    "readable": true,
                                    "writable": true,
                                    "executable": false,
                                    "shared": false
                                }
                            },
                            "hook_overhead_ns": 100
                        }
                    }
                },
                "call_stack": [
                    {
                        "function_name": "current_function",
                        "file_name": "src/unsafe_ffi_tracker.rs",
                        "line_number": 42,
                        "is_unsafe": true
                    }
                ],
                "cross_boundary_events": [
                    {
                        "event_type": "FfiToRust",
                        "timestamp": 1753414296356,
                        "from_context": "libc",
                        "to_context": "rust_main",
                        "stack": [
                            {
                                "function_name": "current_function",
                                "file_name": "src/unsafe_ffi_tracker.rs",
                                "line_number": 42,
                                "is_unsafe": true
                            }
                        ]
                    }
                ],
                "safety_violations": [],
                "ffi_tracked": true,
                "memory_passport": null,
                "ownership_history": null
            },
            {
                "base": {
                    "ptr": 5408583952,
                    "size": 40,
                    "var_name": null,
                    "type_name": null,
                    "scope_name": null,
                    "timestamp_alloc": 1753414296355789000,
                    "timestamp_dealloc": null,
                    "borrow_count": 0,
                    "stack_trace": null,
                    "is_leaked": false,
                    "lifetime_ms": null,
                    "smart_pointer_info": null,
                    "memory_layout": null,
                    "generic_info": null,
                    "dynamic_type_info": null,
                    "runtime_state": null,
                    "stack_allocation": null,
                    "temporary_object": null,
                    "fragmentation_analysis": null,
                    "generic_instantiation": null,
                    "type_relationships": null,
                    "type_usage": null,
                    "function_call_tracking": null,
                    "lifecycle_tracking": null,
                    "access_tracking": null
                },
                "source": {
                    "UnsafeRust": {
                        "unsafe_block_location": "examples/unsafe_ffi_demo.rs:37:13",
                        "call_stack": [
                            {
                                "function_name": "current_function",
                                "file_name": "src/unsafe_ffi_tracker.rs",
                                "line_number": 42,
                                "is_unsafe": true
                            }
                        ],
                        "risk_assessment": {
                            "risk_level": "Medium",
                            "risk_factors": [
                                {
                                    "factor_type": "ManualMemoryManagement",
                                    "severity": 5.0,
                                    "description": "Manual memory management in unsafe block",
                                    "source_location": "examples/unsafe_ffi_demo.rs:37:13"
                                }
                            ],
                            "mitigation_suggestions": [
                                "Ensure proper memory cleanup",
                                "Use RAII patterns where possible"
                            ],
                            "confidence_score": 0.7,
                            "assessment_timestamp": 1753414296355826000
                        }
                    }
                },
                "call_stack": [
                    {
                        "function_name": "current_function",
                        "file_name": "src/unsafe_ffi_tracker.rs",
                        "line_number": 42,
                        "is_unsafe": true
                    }
                ],
                "cross_boundary_events": [
                    {
                        "event_type": "RustToFfi",
                        "timestamp": 1753414296355,
                        "from_context": "unsafe_rust_block",
                        "to_context": "potential_ffi_target",
                        "stack": [
                            {
                                "function_name": "current_function",
                                "file_name": "src/unsafe_ffi_tracker.rs",
                                "line_number": 42,
                                "is_unsafe": true
                            }
                        ]
                    }
                ],
                "safety_violations": [],
                "ffi_tracked": false,
                "memory_passport": null,
                "ownership_history": null
            }
        ];

        // Populate summary data
        document.getElementById('total-complex-types').textContent = 
            complexTypesData.summary.total_complex_types;
        document.getElementById('total-allocations').textContent = 
            complexTypesData.metadata.total_allocations_analyzed;
        document.getElementById('generic-type-count').textContent = 
            complexTypesData.summary.generic_type_count;
        document.getElementById('unsafe-ffi-count').textContent = 
            ffiSnapshotData.length;

        // Populate generic types table with lifetime information
        const tableBody = document.getElementById('generic-types-table-body');
        complexTypesData.categorized_types.generic_types.forEach(type => {
            let typeClass = '';
            if (type.type_name.includes('Vec')) typeClass = 'bg-blue-50';
            else if (type.type_name.includes('Arc')) typeClass = 'bg-green-50';
            else if (type.type_name.includes('Box')) typeClass = 'bg-purple-50';
            else if (type.type_name.includes('Rc')) typeClass = 'bg-yellow-50';
            
            const row = document.createElement('tr');
            row.className = `hover:bg-gray-50 transition-colors ${typeClass}`;
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="font-medium text-neutral">${type.var_name}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900 break-all max-w-xs">${type.type_name}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${type.ptr}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${type.size}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${type.lifetime_ms}ms
                    <div class="lifespan-indicator bg-gray-300 mt-1">
                        <div class="h-full" style="width: ${Math.min(100, type.lifetime_ms)}%; background-color: ${
                            type.type_name.includes('Vec') ? '#3B82F6' :
                            type.type_name.includes('Arc') ? '#10B981' :
                            type.type_name.includes('Box') ? '#8B5CF6' :
                            '#F59E0B'
                        }"></div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                        ${type.complexity_score > 10 ? 'bg-red-100 text-red-800' : 
                          type.complexity_score > 5 ? 'bg-yellow-100 text-yellow-800' : 
                          'bg-green-100 text-green-800'}">
                        ${type.complexity_score}
                    </span>
                </td>
            `;
            tableBody.appendChild(row);
        });

        // Populate optimization recommendations
        const memoryRecList = document.getElementById('memory-optimization-recommendations');
        complexTypesData.optimization_recommendations.forEach(rec => {
            const li = document.createElement('li');
            li.className = 'text-gray-700';
            li.textContent = rec;
            memoryRecList.appendChild(li);
        });

        // Create complexity distribution chart
        const complexityCtx = document.getElementById('complexity-chart').getContext('2d');
        new Chart(complexityCtx, {
            type: 'bar',
            data: {
                labels: ['Low', 'Medium', 'High', 'Very High'],
                datasets: [{
                    label: 'Number of Types',
                    data: [
                        complexTypesData.summary.complexity_distribution.low_complexity,
                        complexTypesData.summary.complexity_distribution.medium_complexity,
                        complexTypesData.summary.complexity_distribution.high_complexity,
                        complexTypesData.summary.complexity_distribution.very_high_complexity
                    ],
                    backgroundColor: [
                        'rgba(16, 185, 129, 0.7)',
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(245, 158, 11, 0.7)',
                        'rgba(239, 68, 68, 0.7)'
                    ],
                    borderColor: [
                        'rgb(16, 185, 129)',
                        'rgb(59, 130, 246)',
                        'rgb(245, 158, 11)',
                        'rgb(239, 68, 68)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // Create memory distribution chart
        const memoryCtx = document.getElementById('memory-distribution-chart').getContext('2d');
        new Chart(memoryCtx, {
            type: 'pie',
            data: {
                labels: complexTypesData.complex_type_analysis.map(a => a.type_name),
                datasets: [{
                    data: complexTypesData.complex_type_analysis.map(a => a.total_size),
                    backgroundColor: [
                        'rgba(245, 158, 11, 0.7)',  // Rc - yellow
                        'rgba(16, 185, 129, 0.7)',  // Arc - green
                        'rgba(139, 92, 246, 0.7)',  // Box - purple
                        'rgba(59, 130, 246, 0.7)',  // Vec - blue
                        'rgba(236, 72, 153, 0.7)'   // String - pink
                    ],
                    borderColor: [
                        'rgb(245, 158, 11)',
                        'rgb(16, 185, 129)',
                        'rgb(139, 92, 246)',
                        'rgb(59, 130, 246)',
                        'rgb(236, 72, 153)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${context.label}: ${value} bytes (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Render FFI data with collapsible sections
        function renderFfiData(data, container) {
            data.forEach((item, index) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'bg-white rounded-lg card-shadow hover-lift border-l-4 ' + 
                                    (item.source.FfiC ? 'border-blue-500' : 'border-yellow-500');
                
                const sourceType = item.source.FfiC ? 'FFI (C)' : 'Unsafe Rust';
                const sourceColor = item.source.FfiC ? 'text-blue-500' : 'text-yellow-500';
                
                // Create header with toggle button
                const headerDiv = document.createElement('div');
                headerDiv.className = 'p-5 cursor-pointer flex justify-between items-center';
                headerDiv.innerHTML = `
                    <div class="font-semibold text-lg ${sourceColor}">Entry ${index + 1}: ${sourceType}</div>
                    <i class="fa fa-chevron-down rotate-icon"></i>
                `;
                entryDiv.appendChild(headerDiv);
                
                // Create collapsible content
                const contentDiv = document.createElement('div');
                contentDiv.className = 'collapsible-content px-5 pb-5 border-t border-gray-100';
                entryDiv.appendChild(contentDiv);
                
                // Render the data inside collapsible content
                renderFfiObject(item, contentDiv);
                container.appendChild(entryDiv);
                
                // Add click handler for toggle
                headerDiv.addEventListener('click', () => {
                    contentDiv.classList.toggle('active');
                    headerDiv.querySelector('.rotate-icon').classList.toggle('active');
                });
            });
        }

        function renderFfiObject(obj, container, level = 0) {
            // Limit nesting depth to prevent excessive expansion
            if (level > 3) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'text-gray-500 text-sm italic mt-1';
                moreDiv.textContent = '(Content truncated for readability)';
                container.appendChild(moreDiv);
                return;
            }
            
            for (const [key, value] of Object.entries(obj)) {
                // Skip null values and empty objects
                if (value === null || (typeof value === 'object' && Object.keys(value).length === 0)) {
                    continue;
                }
                
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'mb-4';
                
                const keyDiv = document.createElement('div');
                keyDiv.className = 'font-medium text-neutral mb-2';
                keyDiv.textContent = key.charAt(0).toUpperCase() + key.slice(1);
                sectionDiv.appendChild(keyDiv);

                const valueDiv = document.createElement('div');
                valueDiv.className = 'pl-4 border-l-2 border-gray-200';

                if (typeof value === 'object') {
                    if (Array.isArray(value)) {
                        // For arrays, show count and allow expansion
                        const arrayHeader = document.createElement('div');
                        arrayHeader.className = 'font-medium text-sm text-gray-600 cursor-pointer flex items-center';
                        arrayHeader.innerHTML = `
                            Array (${value.length} items)
                            <i class="fa fa-chevron-down rotate-icon ml-2 text-xs"></i>
                        `;
                        valueDiv.appendChild(arrayHeader);
                        
                        const arrayContent = document.createElement('div');
                        arrayContent.className = 'collapsible-content mt-2';
                        valueDiv.appendChild(arrayContent);
                        
                        value.forEach((item, idx) => {
                            const arrayItemDiv = document.createElement('div');
                            arrayItemDiv.className = 'mb-3';
                            arrayItemDiv.innerHTML = `<div class="font-medium text-sm text-gray-600">Item ${idx + 1}:</div>`;
                            renderFfiObject(item, arrayItemDiv, level + 1);
                            arrayContent.appendChild(arrayItemDiv);
                        });
                        
                        // Add click handler for array toggle
                        arrayHeader.addEventListener('click', () => {
                            arrayContent.classList.toggle('active');
                            arrayHeader.querySelector('.rotate-icon').classList.toggle('active');
                        });
                    } else {
                        // For objects, create a toggleable section
                        const objectHeader = document.createElement('div');
                        objectHeader.className = 'font-medium text-sm text-gray-600 cursor-pointer flex items-center';
                        objectHeader.innerHTML = `
                            Object
                            <i class="fa fa-chevron-down rotate-icon ml-2 text-xs"></i>
                        `;
                        valueDiv.appendChild(objectHeader);
                        
                        const objectContent = document.createElement('div');
                        objectContent.className = 'collapsible-content mt-2';
                        valueDiv.appendChild(objectContent);
                        
                        renderFfiObject(value, objectContent, level + 1);
                        
                        // Add click handler for object toggle
                        objectHeader.addEventListener('click', () => {
                            objectContent.classList.toggle('active');
                            objectHeader.querySelector('.rotate-icon').classList.toggle('active');
                        });
                    }
                } else {
                    // For primitive values, just display them
                    valueDiv.textContent = value;
                }

                sectionDiv.appendChild(valueDiv);
                container.appendChild(sectionDiv);
            }
        }

        renderFfiData(ffiSnapshotData, document.getElementById('ffi-data-render'));

        // Initialize SVG interactions for variable graph
        function initVariableSvgInteractions() {
            const svg = document.querySelector("svg");
            const zoomContainer = svg.getElementById("var-zoom-container");
            const tooltip = svg.getElementById("var-tooltip");
            const tooltipBg = svg.getElementById("var-tooltip-bg");
            const tooltipText = svg.getElementById("var-tooltip-text");
            
            let scale = 1;
            let translateX = 0;
            let translateY = 0;
            let isDragging = false;
            let startX, startY;
            let initialTranslateX, initialTranslateY;
            
            const nodes = svg.querySelectorAll(".node-ffi");
            nodes.forEach(node => {
                node.addEventListener("mouseover", function(e) {
                    const nodeId = this.id;
                    const type = this.getAttribute("data-type") || "N/A";
                    const size = this.getAttribute("data-size") || "N/A";
                    const ptr = this.getAttribute("data-ptr") || "N/A";
                    const lifetime = this.getAttribute("data-lifetime") || "N/A";
                    const info = this.getAttribute("data-info") || "";
                    
                    let content = `${nodeId}`;
                    if (type !== "N/A") content += `\nType: ${type}`;
                    if (size !== "N/A") content += `\nSize: ${size}`;
                    if (ptr !== "N/A") content += `\nPtr: ${ptr}`;
                    if (lifetime !== "N/A") content += `\nLifetime: ${lifetime}`;
                    if (info) content += `\n${info}`;
                    
                    tooltipText.textContent = content;
                    
                    const lines = content.split("\n").length;
                    const textLength = tooltipText.getComputedTextLength();
                    tooltipBg.setAttribute("width", Math.max(textLength + 16, 120));
                    tooltipBg.setAttribute("height", lines * 18 + 8);
                    
                    const pt = svg.createSVGPoint();
                    pt.x = e.clientX;
                    pt.y = e.clientY;
                    const svgPt = pt.matrixTransform(svg.getScreenCTM().inverse());
                    
                    tooltip.setAttribute("transform", `translate(${svgPt.x + 10}, ${svgPt.y + 10})`);
                    tooltip.setAttribute("visibility", "visible");
                });
                
                node.addEventListener("mouseout", function() {
                    tooltip.setAttribute("visibility", "hidden");
                });
            });
            
            // Zoom functionality
            svg.addEventListener("wheel", function(e) {
                if (!e.target.closest("#var-zoom-container")) return;
                
                e.preventDefault();
                const pt = svg.createSVGPoint();
                pt.x = e.clientX;
                pt.y = e.clientY;
                const svgPt = pt.matrixTransform(zoomContainer.getScreenCTM().inverse());
                
                const delta = e.deltaY < 0 ? 0.1 : -0.1;
                const newScale = Math.max(0.5, Math.min(2, scale + delta));
                
                translateX = svgPt.x - (svgPt.x - translateX) * (newScale / scale);
                translateY = svgPt.y - (svgPt.y - translateY) * (newScale / scale);
                
                scale = newScale;
                updateVariableTransform();
            });
            
            // Pan functionality
            svg.addEventListener("mousedown", function(e) {
                if (e.target.closest("#var-zoom-container") && 
                    (e.target === svg || e.target.tagName === "rect" && e.target.getAttribute("class") === "subgraph")) {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialTranslateX = translateX;
                    initialTranslateY = translateY;
                    svg.style.cursor = "grabbing";
                }
            });
            
            window.addEventListener("mousemove", function(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                translateX = initialTranslateX + dx / scale;
                translateY = initialTranslateY + dy / scale;
                
                updateVariableTransform();
            });
            
            window.addEventListener("mouseup", function() {
                isDragging = false;
                svg.style.cursor = "default";
            });
            
            function updateVariableTransform() {
                zoomContainer.setAttribute("transform", `translate(${translateX}, ${translateY}) scale(${scale})`);
            }
        }

        // Initialize all interactions when page loads
        window.addEventListener('load', function() {
            initVariableSvgInteractions();
            
            // Expand first FFI entry by default
            const firstFfiEntry = document.querySelector('#ffi-data-render .collapsible-content');
            if (firstFfiEntry) {
                firstFfiEntry.classList.add('active');
                const icon = firstFfiEntry.previousElementSibling.querySelector('.rotate-icon');
                if (icon) icon.classList.add('active');
            }
        });
    </script>
</body>
</html>
