<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MemScope Enhanced Memory Analysis Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-blue: #3b82f6;
      --primary-green: #10b981;
      --primary-orange: #f59e0b;
      --primary-red: #ef4444;
      --primary-purple: #8b5cf6;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border-light: #e5e7eb;
      --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .dark {
      --bg-primary: #1f2937;
      --bg-secondary: #111827;
      --text-primary: #f9fafb;
      --text-secondary: #d1d5db;
      --border-light: #374151;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      line-height: 1.6;
      transition: all 0.3s ease;
    }

    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding: 24px;
      background: var(--bg-primary);
      border-radius: 12px;
      box-shadow: var(--shadow-medium);
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-blue);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--primary-blue);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    .grid {
      display: grid;
      gap: 20px;
      margin-bottom: 32px;
    }

    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }

    .card {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow-light);
      border: 1px solid var(--border-light);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: var(--shadow-medium);
    }

    .card h2 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .kpi-card {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow-light);
      border: 1px solid var(--border-light);
      transition: all 0.3s ease;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-medium);
    }

    .kpi-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-blue);
      margin-bottom: 8px;
    }

    .kpi-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }

    th {
      background: var(--bg-secondary);
      font-weight: 600;
      color: var(--text-primary);
    }

    tr:hover {
      background: var(--bg-secondary);
    }

    .scroll {
      max-height: 400px;
      overflow: auto;
    }

    .scroll::-webkit-scrollbar {
      width: 6px;
    }

    .scroll::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .scroll::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 3px;
    }

    /* 新增样式：分配类型标识 */
    .allocation-type {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .type-heap { 
      background: #fef3c7; 
      color: #92400e; 
      border: 1px solid #f59e0b;
    }
    
    .type-stack { 
      background: #dbeafe; 
      color: #1e40af; 
      border: 1px solid #3b82f6;
    }
    
    .type-unknown { 
      background: #f3f4f6; 
      color: #6b7280; 
      border: 1px solid #9ca3af;
    }

    .dark .type-heap { 
      background: #78350f; 
      color: #fbbf24; 
    }
    
    .dark .type-stack { 
      background: #1e3a8a; 
      color: #60a5fa; 
    }
    
    .dark .type-unknown { 
      background: #374151; 
      color: #d1d5db; 
    }

    /* 时间显示样式 */
    .time-info {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .time-badge {
      display: inline-block;
      padding: 2px 6px;
      background: var(--bg-secondary);
      border-radius: 4px;
      margin-right: 8px;
      font-family: monospace;
    }

    /* 生命周期可视化 */
    .lifecycle-bar {
      height: 20px;
      background: var(--bg-secondary);
      border-radius: 10px;
      position: relative;
      overflow: hidden;
      margin: 8px 0;
    }

    .lifecycle-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-green), var(--primary-blue));
      border-radius: 10px;
      position: relative;
    }

    .lifecycle-marker {
      position: absolute;
      top: 0;
      width: 2px;
      height: 100%;
      background: var(--primary-red);
    }

    /* 状态指示器 */
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-active { background: #dcfce7; color: #166534; }
    .status-leaked { background: #fee2e2; color: #dc2626; }
    .status-freed { background: #e5e7eb; color: #374151; }

    .dark .status-active { background: #064e3b; color: #34d399; }
    .dark .status-leaked { background: #7f1d1d; color: #fca5a5; }
    .dark .status-freed { background: #374151; color: #d1d5db; }

    @media (max-width: 768px) {
      .grid-2, .grid-3, .grid-4 {
        grid-template-columns: 1fr;
        gap: 16px;
        text-align: center;
      }
    }
  </style>
  <script>
    window.analysisData = {{ json_data }};
  </script>
</head>
<body>
  <div class="dashboard-container">
    <!-- Header -->
    <header class="header">
      <div>
        <h1>MemScope Enhanced Memory Analysis Dashboard</h1>
        <div class="subtitle">增强版内存分析 - 支持堆/栈分配类型和时间追踪</div>
      </div>
      <button id="theme-toggle" class="theme-toggle">
        <i class="fa fa-moon"></i>
        <span>切换主题</span>
      </button>
    </header>

    <!-- KPI Metrics -->
    <section class="grid grid-4">
      <div class="kpi-card">
        <div class="kpi-value" id="total-allocations">-</div>
        <div class="kpi-label">总分配数</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="heap-allocations">-</div>
        <div class="kpi-label">堆分配</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="stack-allocations">-</div>
        <div class="kpi-label">栈分配</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="avg-lifetime">-</div>
        <div class="kpi-label">平均生命周期</div>
      </div>
    </section>

    <!-- 分配类型分布 -->
    <section class="grid grid-2">
      <div class="card">
        <h2><i class="fa fa-chart-pie"></i> 分配类型分布</h2>
        <div id="allocationTypeChart" style="height: 300px;"></div>
      </div>
      
      <div class="card">
        <h2><i class="fa fa-clock"></i> 时间线分析</h2>
        <div id="timelineChart" style="height: 300px;"></div>
      </div>
    </section>

    <!-- 增强的变量详情表 -->
    <section class="card">
      <h2><i class="fa fa-table"></i> 详细内存分配信息</h2>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>变量名</th>
              <th>类型</th>
              <th>分配类型</th>
              <th>大小</th>
              <th>分配时间</th>
              <th>Drop时间</th>
              <th>生命周期</th>
              <th>状态</th>
            </tr>
          </thead>
          <tbody id="enhancedAllocTable"></tbody>
        </table>
      </div>
    </section>

    <!-- 生命周期可视化 -->
    <section class="card">
      <h2><i class="fa fa-timeline"></i> 变量生命周期可视化</h2>
      <div id="lifecycleVisualization" style="max-height: 400px; overflow-y: auto;"></div>
    </section>

  </div>

  <script>
    // 工具函数：推断分配类型
    function inferAllocationType(typeName) {
      if (!typeName) return 'unknown';
      
      const heapTypes = ['Box', 'Vec', 'String', 'HashMap', 'BTreeMap', 'Arc', 'Rc'];
      const stackTypes = ['i32', 'i64', 'f32', 'f64', 'bool', 'char', 'usize', 'isize'];
      
      for (const heapType of heapTypes) {
        if (typeName.includes(heapType)) return 'heap';
      }
      
      for (const stackType of stackTypes) {
        if (typeName.includes(stackType)) return 'stack';
      }
      
      // 如果包含指针或引用，通常是堆分配
      if (typeName.includes('*') || typeName.includes('&')) return 'heap';
      
      return 'unknown';
    }

    // 格式化时间戳
    function formatTimestamp(timestamp) {
      if (!timestamp) return 'N/A';
      const date = new Date(timestamp / 1000000); // 纳秒转毫秒
      return date.toLocaleTimeString() + '.' + String(date.getMilliseconds()).padStart(3, '0');
    }

    // 计算Drop时间
    function calculateDropTime(allocTime, lifetimeMs) {
      if (!allocTime || lifetimeMs === undefined) return null;
      return allocTime + (lifetimeMs * 1000000); // 毫秒转纳秒
    }

    // 格式化生命周期
    function formatLifetime(lifetimeMs) {
      if (lifetimeMs === undefined || lifetimeMs === null) return 'N/A';
      if (lifetimeMs < 1) return `${(lifetimeMs * 1000).toFixed(2)}μs`;
      if (lifetimeMs < 1000) return `${lifetimeMs.toFixed(2)}ms`;
      return `${(lifetimeMs / 1000).toFixed(2)}s`;
    }

    // 初始化仪表板
    function initDashboard() {
      if (!window.analysisData || !window.analysisData.allocations) {
        console.error('No analysis data available');
        return;
      }

      const allocations = window.analysisData.allocations;
      
      // 统计分配类型
      let heapCount = 0, stackCount = 0, unknownCount = 0;
      let totalLifetime = 0, validLifetimes = 0;

      allocations.forEach(alloc => {
        const type = inferAllocationType(alloc.type_name);
        if (type === 'heap') heapCount++;
        else if (type === 'stack') stackCount++;
        else unknownCount++;

        if (alloc.lifetime_ms !== undefined && alloc.lifetime_ms !== null) {
          totalLifetime += alloc.lifetime_ms;
          validLifetimes++;
        }
      });

      // 更新KPI
      document.getElementById('total-allocations').textContent = allocations.length;
      document.getElementById('heap-allocations').textContent = heapCount;
      document.getElementById('stack-allocations').textContent = stackCount;
      document.getElementById('avg-lifetime').textContent = 
        validLifetimes > 0 ? formatLifetime(totalLifetime / validLifetimes) : 'N/A';

      // 填充增强表格
      populateEnhancedTable(allocations);
      
      // 创建生命周期可视化
      createLifecycleVisualization(allocations);
      
      // 创建分配类型图表
      createAllocationTypeChart(heapCount, stackCount, unknownCount);
    }

    // 填充增强表格
    function populateEnhancedTable(allocations) {
      const tbody = document.getElementById('enhancedAllocTable');
      tbody.innerHTML = '';

      allocations.forEach(alloc => {
        const row = document.createElement('tr');
        const allocType = inferAllocationType(alloc.type_name);
        const dropTime = calculateDropTime(alloc.timestamp_alloc, alloc.lifetime_ms);
        
        row.innerHTML = `
          <td>${alloc.var_name || 'unnamed'}</td>
          <td title="${alloc.type_name}">${(alloc.type_name || '').substring(0, 30)}${(alloc.type_name || '').length > 30 ? '...' : ''}</td>
          <td><span class="allocation-type type-${allocType}">${allocType}</span></td>
          <td>${alloc.size || 0} bytes</td>
          <td>
            <span class="time-badge">${formatTimestamp(alloc.timestamp_alloc)}</span>
          </td>
          <td>
            <span class="time-badge">${dropTime ? formatTimestamp(dropTime) : 'N/A'}</span>
          </td>
          <td>${formatLifetime(alloc.lifetime_ms)}</td>
          <td><span class="status-badge status-${alloc.is_leaked ? 'leaked' : 'freed'}">${alloc.is_leaked ? '泄漏' : '已释放'}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    // 创建生命周期可视化
    function createLifecycleVisualization(allocations) {
      const container = document.getElementById('lifecycleVisualization');
      container.innerHTML = '';

      // 按时间排序
      const sortedAllocs = [...allocations].sort((a, b) => a.timestamp_alloc - b.timestamp_alloc);
      const minTime = Math.min(...sortedAllocs.map(a => a.timestamp_alloc));
      const maxTime = Math.max(...sortedAllocs.map(a => {
        const dropTime = calculateDropTime(a.timestamp_alloc, a.lifetime_ms);
        return dropTime || a.timestamp_alloc;
      }));
      const timeRange = maxTime - minTime;

      sortedAllocs.forEach((alloc, index) => {
        const allocType = inferAllocationType(alloc.type_name);
        const dropTime = calculateDropTime(alloc.timestamp_alloc, alloc.lifetime_ms);
        
        const startPercent = ((alloc.timestamp_alloc - minTime) / timeRange) * 100;
        const endPercent = dropTime ? ((dropTime - minTime) / timeRange) * 100 : startPercent + 1;
        const width = Math.max(endPercent - startPercent, 1);

        const item = document.createElement('div');
        item.style.cssText = `
          margin: 4px 0;
          padding: 8px;
          background: var(--bg-secondary);
          border-radius: 6px;
          border-left: 4px solid ${allocType === 'heap' ? 'var(--primary-orange)' : allocType === 'stack' ? 'var(--primary-blue)' : 'var(--text-secondary)'};
        `;
        
        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 600;">${alloc.var_name || 'unnamed'}</span>
            <span class="allocation-type type-${allocType}">${allocType}</span>
          </div>
          <div class="lifecycle-bar">
            <div class="lifecycle-progress" style="width: ${width}%; margin-left: ${startPercent}%;"></div>
          </div>
          <div class="time-info">
            <span class="time-badge">开始: ${formatTimestamp(alloc.timestamp_alloc)}</span>
            <span class="time-badge">结束: ${dropTime ? formatTimestamp(dropTime) : 'N/A'}</span>
            <span class="time-badge">持续: ${formatLifetime(alloc.lifetime_ms)}</span>
          </div>
        `;
        
        container.appendChild(item);
      });
    }

    // 创建分配类型图表（简单版本）
    function createAllocationTypeChart(heapCount, stackCount, unknownCount) {
      const container = document.getElementById('allocationTypeChart');
      const total = heapCount + stackCount + unknownCount;
      
      if (total === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); margin-top: 100px;">暂无数据</div>';
        return;
      }

      const heapPercent = (heapCount / total) * 100;
      const stackPercent = (stackCount / total) * 100;
      const unknownPercent = (unknownCount / total) * 100;

      container.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 16px; padding: 20px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 20px; height: 20px; background: var(--primary-orange); border-radius: 4px;"></div>
            <span>堆分配: ${heapCount} (${heapPercent.toFixed(1)}%)</span>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 20px; height: 20px; background: var(--primary-blue); border-radius: 4px;"></div>
            <span>栈分配: ${stackCount} (${stackPercent.toFixed(1)}%)</span>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 20px; height: 20px; background: var(--text-secondary); border-radius: 4px;"></div>
            <span>未知类型: ${unknownCount} (${unknownPercent.toFixed(1)}%)</span>
          </div>
          <div style="height: 20px; background: var(--bg-secondary); border-radius: 10px; overflow: hidden; margin-top: 16px;">
            <div style="height: 100%; display: flex;">
              <div style="width: ${heapPercent}%; background: var(--primary-orange);"></div>
              <div style="width: ${stackPercent}%; background: var(--primary-blue);"></div>
              <div style="width: ${unknownPercent}%; background: var(--text-secondary);"></div>
            </div>
          </div>
        </div>
      `;
    }

    // 主题切换
    function initThemeToggle() {
      const themeToggle = document.getElementById('theme-toggle');
      const body = document.body;
      
      themeToggle.addEventListener('click', () => {
        body.classList.toggle('dark');
        const icon = themeToggle.querySelector('i');
        const text = themeToggle.querySelector('span');
        
        if (body.classList.contains('dark')) {
          icon.className = 'fa fa-sun';
          text.textContent = '亮色主题';
        } else {
          icon.className = 'fa fa-moon';
          text.textContent = '暗色主题';
        }
      });
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
      initDashboard();
      initThemeToggle();
    });
  </script>
</body>
</html>