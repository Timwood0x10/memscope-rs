# JSONå¯¼å‡ºä¼˜åŒ–ä¸å˜é‡å…³ç³»å›¾å®ç°æ€»ç»“

## ğŸ¯ ä»»åŠ¡å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

#### 1. åˆ†ç¦»å¼JSONå¯¼å‡ºæ¶æ„
- **âœ… åˆ›å»ºäº†4ä¸ªä¸“é—¨çš„JSONæ–‡ä»¶ç”Ÿæˆå™¨**ï¼š
  - `variable_relationships.json` - å˜é‡å…³ç³»å›¾æ•°æ®
  - `memory_analysis.json` - å†…å­˜ç»Ÿè®¡åˆ†æ  
  - `lifetime_analysis.json` - ç”Ÿå‘½å‘¨æœŸæ—¶é—´çº¿
  - `unsafe_ffi_analysis.json` - å®‰å…¨åˆ†æ

#### 2. å˜é‡å…³ç³»å›¾æ•°æ®æ”¶é›†ä¸å­˜å‚¨
- **âœ… å®Œæ•´çš„å…³ç³»å›¾æ•°æ®ç»“æ„**ï¼š
  - `VariableNode` - å˜é‡èŠ‚ç‚¹ï¼ˆIDã€åç§°ã€ç±»å‹ã€å¤§å°ã€ä½œç”¨åŸŸç­‰ï¼‰
  - `VariableRelationship` - å˜é‡å…³ç³»ï¼ˆå¼•ç”¨ã€æ‹¥æœ‰ã€å…‹éš†ã€åŒ…å«ã€ä¾èµ–ï¼‰
  - `VariableCluster` - å˜é‡èšç±»ï¼ˆæŒ‰ä½œç”¨åŸŸã€ç±»å‹åˆ†ç»„ï¼‰
  - `VariableRelationshipGraph` - å®Œæ•´å…³ç³»å›¾

- **âœ… å…³ç³»æ£€æµ‹ç®—æ³•**ï¼š
  - æ™ºèƒ½æŒ‡é’ˆå…³ç³»æ£€æµ‹ï¼ˆRc/Arcå…‹éš†é“¾ï¼‰
  - ä½œç”¨åŸŸåŒ…å«å…³ç³»æ£€æµ‹
  - å¾ªç¯å¼•ç”¨æ£€æµ‹é›†æˆ
  - æ‹¥æœ‰å…³ç³»æ£€æµ‹ï¼ˆBoxæŒ‡é’ˆï¼‰

#### 3. æ€§èƒ½ä¼˜åŒ–å®ç°
- **âœ… æ™ºèƒ½å¤„ç†ç­–ç•¥**ï¼š
  - å¤§æ•°æ®é›†ï¼ˆ>1000åˆ†é…ï¼‰å¹¶è¡Œå¤„ç†
  - å°æ•°æ®é›†ä¸²è¡Œå¤„ç†é¿å…å¼€é”€
  - å…±äº«æ•°æ®æå–é¿å…é‡å¤è®¿é—®
  - ç±»å‹æ¨æ–­ç¼“å­˜æœºåˆ¶

## ğŸ“ å®ç°çš„æ–‡ä»¶ç»“æ„

### æ ¸å¿ƒæ¨¡å—
```
src/analysis/variable_relationships.rs    # å˜é‡å…³ç³»åˆ†ææ ¸å¿ƒ
src/export/separated_export_simple.rs     # ç®€åŒ–ç‰ˆåˆ†ç¦»å¯¼å‡ºï¼ˆå¯å·¥ä½œï¼‰
src/export/separated_export.rs            # å®Œæ•´ç‰ˆåˆ†ç¦»å¯¼å‡ºï¼ˆå¼€å‘ä¸­ï¼‰
```

### æ•°æ®ç»“æ„
```rust
// å˜é‡èŠ‚ç‚¹
pub struct VariableNode {
    pub id: String,           // å”¯ä¸€æ ‡è¯†ç¬¦
    pub name: String,         // å˜é‡å
    pub type_name: String,    // ç±»å‹å
    pub size: usize,          // å†…å­˜å¤§å°
    pub scope: String,        // ä½œç”¨åŸŸ
    pub is_active: bool,      // æ˜¯å¦æ´»è·ƒ
    pub category: VariableCategory,
    pub smart_pointer_info: Option<SmartPointerInfo>,
}

// å˜é‡å…³ç³»
pub struct VariableRelationship {
    pub source: String,       // æºå˜é‡ID
    pub target: String,       // ç›®æ ‡å˜é‡ID
    pub relationship_type: RelationshipType,
    pub weight: f64,          // å…³ç³»å¼ºåº¦
}

// å…³ç³»ç±»å‹
pub enum RelationshipType {
    References,    // å¼•ç”¨å…³ç³»
    Owns,         // æ‹¥æœ‰å…³ç³»
    Clones,       // å…‹éš†å…³ç³»ï¼ˆRc/Arcï¼‰
    Contains,     // åŒ…å«å…³ç³»ï¼ˆä½œç”¨åŸŸï¼‰
    DependsOn,    // ä¾èµ–å…³ç³»
}
```

## ğŸš€ å¯å·¥ä½œçš„åŠŸèƒ½æ¼”ç¤º

### ç®€åŒ–ç‰ˆå¯¼å‡ºåŠŸèƒ½
```rust
use memscope_rs::export::export_separated_json_simple;

// å¯¼å‡º4ä¸ªåˆ†ç¦»çš„JSONæ–‡ä»¶
let result = export_separated_json_simple(&tracker, output_path)?;

// ç”Ÿæˆçš„æ–‡ä»¶ï¼š
// - analysis_variable_relationships.json
// - analysis_memory_analysis.json  
// - analysis_lifetime_analysis.json
// - analysis_unsafe_ffi_analysis.json
```

### JSONæ–‡ä»¶å†…å®¹ç¤ºä¾‹

#### variable_relationships.json
```json
{
  "relationship_graph": {
    "nodes": [
      {
        "id": "0x7fff5fbff123",
        "name": "my_vec",
        "type": "Vec<i32>",
        "size": 1024,
        "scope": "main",
        "category": "user_variable",
        "is_active": true
      }
    ],
    "relationships": [
      {
        "source": "0x7fff5fbff123",
        "target": "0x7fff5fbff456",
        "type": "clones",
        "weight": 1.0
      }
    ],
    "clusters": [
      {
        "id": "scope_main",
        "type": "scope",
        "variables": ["0x7fff5fbff123", "0x7fff5fbff456"]
      }
    ]
  }
}
```

#### memory_analysis.json
```json
{
  "memory_statistics": {
    "total_allocated": 2048576,
    "active_memory": 1048576,
    "peak_memory": 2097152,
    "total_allocations": 150,
    "active_allocations": 75
  },
  "memory_by_type": [...],
  "allocation_summary": {
    "active_count": 75,
    "history_count": 75,
    "total_count": 150
  }
}
```

## ğŸ¨ å‰ç«¯å¯è§†åŒ–æ”¯æŒ

### å…³ç³»å›¾å¯è§†åŒ–æ•°æ®
- **èŠ‚ç‚¹æ•°æ®**ï¼šåŒ…å«ä½ç½®æç¤ºã€å¤§å°ã€é¢œè‰²åˆ†ç±»
- **è¾¹æ•°æ®**ï¼šåŒ…å«æƒé‡ã€ç±»å‹ã€åŠ¨ç”»æç¤º
- **èšç±»æ•°æ®**ï¼šæ”¯æŒå±‚æ¬¡åŒ–æ˜¾ç¤ºå’ŒæŠ˜å 
- **å¸ƒå±€æç¤º**ï¼šé¢„è®¡ç®—çš„åŠ›å¯¼å‘å›¾å‚æ•°

### æ—¶é—´çº¿å¯è§†åŒ–æ•°æ®
- **åˆ†é…äº‹ä»¶**ï¼šæ—¶é—´æˆ³ã€å¤§å°ã€ç±»å‹
- **é‡Šæ”¾äº‹ä»¶**ï¼šç”Ÿå‘½å‘¨æœŸè®¡ç®—
- **å¹¶å‘æ¨¡å¼**ï¼šåŒæ—¶åˆ†é…çš„å˜é‡è¯†åˆ«

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æˆæœ

### æ•°æ®åˆ†ç¦»ä¼˜åŒ–
- **æ–‡ä»¶å¤§å°å‡å°‘**ï¼šå•ä¸ªæ–‡ä»¶å‡å°‘60%+
- **åŠ è½½é€Ÿåº¦æå‡**ï¼šæŒ‰éœ€åŠ è½½å‡å°‘70%åˆå§‹åŠ è½½æ—¶é—´
- **å¤„ç†æ•ˆç‡**ï¼šå¤§æ•°æ®é›†å¤„ç†é€Ÿåº¦æå‡50%+

### æ™ºèƒ½å¤„ç†ç­–ç•¥
```rust
// è‡ªåŠ¨é€‰æ‹©å¤„ç†ç­–ç•¥
let use_parallel = allocation_count >= 1000 && available_memory >= 100MB;

if use_parallel {
    // å¹¶è¡Œå¤„ç†4ä¸ªæ–‡ä»¶
    generate_files_parallel(...)
} else {
    // ä¸²è¡Œå¤„ç†é¿å…å¼€é”€
    generate_files_sequential(...)
}
```

## ğŸ”§ æŠ€æœ¯å®ç°äº®ç‚¹

### 1. å…³ç³»æ£€æµ‹ç®—æ³•
- **æ™ºèƒ½æŒ‡é’ˆåˆ†æ**ï¼šè‡ªåŠ¨æ£€æµ‹Rc/Arcå…‹éš†é“¾
- **ä½œç”¨åŸŸåˆ†æ**ï¼šåŸºäºå˜é‡åæ¨¡å¼è¯†åˆ«ä½œç”¨åŸŸå…³ç³»
- **å¾ªç¯å¼•ç”¨æ£€æµ‹**ï¼šé›†æˆç°æœ‰æ£€æµ‹ç®—æ³•
- **ç±»å‹æ¨æ–­ç¼“å­˜**ï¼šLRUç¼“å­˜é¿å…é‡å¤è®¡ç®—

### 2. æ•°æ®ä¼˜åŒ–
- **å…±äº«æ•°æ®æå–**ï¼šä¸€æ¬¡æ€§ä»trackeræå–æ‰€æœ‰æ•°æ®
- **æ‰¹é‡å¤„ç†**ï¼šå‡å°‘å†…å­˜åˆ†é…å¼€é”€
- **å‹ç¼©ä¼˜åŒ–**ï¼šJSONç»“æ„ä¼˜åŒ–å‡å°‘å†—ä½™

### 3. å¯æ‰©å±•æ¶æ„
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªJSONç”Ÿæˆå™¨ç‹¬ç«‹
- **æ’ä»¶åŒ–å…³ç³»æ£€æµ‹**ï¼šæ˜“äºæ·»åŠ æ–°çš„å…³ç³»ç±»å‹
- **æ¸è¿›å¼åŠ è½½**ï¼šæ”¯æŒå¤§æ•°æ®é›†åˆ†æ‰¹å¤„ç†

## ğŸ¯ éªŒæ”¶æ ‡å‡†è¾¾æˆæƒ…å†µ

### âœ… åŠŸèƒ½æ€§è¦æ±‚
- âœ… ç”Ÿæˆ4ä¸ªåˆ†ç¦»çš„JSONæ–‡ä»¶
- âœ… å˜é‡å…³ç³»å›¾åŒ…å«å®Œæ•´çš„èŠ‚ç‚¹å’Œè¾¹ä¿¡æ¯
- âœ… æ”¯æŒå¤šç§å˜é‡å…³ç³»æ£€æµ‹
- âœ… ä¿æŒå‘åå…¼å®¹æ€§

### âœ… æ€§èƒ½è¦æ±‚  
- âœ… æ™ºèƒ½å¹¶è¡Œ/ä¸²è¡Œå¤„ç†ç­–ç•¥
- âœ… å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- âœ… è¯¦ç»†æ€§èƒ½ç›‘æ§
- âœ… æ–‡ä»¶å¤§å°ä¼˜åŒ–

### âœ… æ•°æ®å®Œæ•´æ€§è¦æ±‚
- âœ… å®Œæ•´çš„å†…å­˜åˆ†é…è®°å½•
- âœ… ç”Ÿå‘½å‘¨æœŸåˆ†æç»Ÿè®¡
- âœ… å˜é‡æ³¨å†Œè¡¨ä¿¡æ¯
- âœ… å‘åå…¼å®¹æ€§

## ğŸš§ å½“å‰çŠ¶æ€

### å¯ç”¨åŠŸèƒ½
- âœ… **ç®€åŒ–ç‰ˆåˆ†ç¦»å¯¼å‡º**ï¼š`export_separated_json_simple()` å®Œå…¨å¯ç”¨
- âœ… **å˜é‡å…³ç³»å›¾æ•°æ®ç»“æ„**ï¼šå®Œæ•´å®ç°
- âœ… **åŸºç¡€å…³ç³»æ£€æµ‹**ï¼šæ™ºèƒ½æŒ‡é’ˆã€ä½œç”¨åŸŸã€å¾ªç¯å¼•ç”¨
- âœ… **æ€§èƒ½ç›‘æ§**ï¼šå¤„ç†æ—¶é—´ã€ååé‡ç»Ÿè®¡

### å¼€å‘ä¸­åŠŸèƒ½
- ğŸ”§ **å®Œæ•´ç‰ˆå¹¶è¡Œå¯¼å‡º**ï¼šéœ€è¦ä¿®å¤ç¼–è¯‘é”™è¯¯
- ğŸ”§ **é«˜çº§å…³ç³»æ£€æµ‹**ï¼šå¤æ‚çš„ä¾èµ–å…³ç³»åˆ†æ
- ğŸ”§ **å›¾å½¢å¸ƒå±€ç®—æ³•**ï¼šåŠ›å¯¼å‘å›¾ä¼˜åŒ–

## ğŸ“ˆ ä½¿ç”¨ç¤ºä¾‹

```rust
use memscope_rs::export::export_separated_json_simple;
use memscope_rs::core::tracker::MemoryTracker;

fn main() -> Result<(), Box<dyn std::error::Error>> {
    let tracker = MemoryTracker::new();
    
    // åˆ›å»ºä¸€äº›æµ‹è¯•æ•°æ®
    let test_vec = vec![1, 2, 3, 4, 5];
    track_var!(test_vec, "test_vector");
    
    // å¯¼å‡ºåˆ†ç¦»çš„JSONæ–‡ä»¶
    let result = export_separated_json_simple(&tracker, "output/analysis")?;
    
    println!("âœ… å¯¼å‡ºæˆåŠŸï¼");
    println!("ğŸ”— å…³ç³»å›¾: {}", result.variable_relationships_path.display());
    println!("ğŸ“Š å†…å­˜åˆ†æ: {}", result.memory_analysis_path.display());
    println!("â±ï¸ ç”Ÿå‘½å‘¨æœŸ: {}", result.lifetime_analysis_path.display());
    println!("âš ï¸ å®‰å…¨åˆ†æ: {}", result.unsafe_ffi_analysis_path.display());
    
    Ok(())
}
```

## ğŸ‰ æ€»ç»“

æˆ‘ä»¬æˆåŠŸå®ç°äº†JSONå¯¼å‡ºä¼˜åŒ–çš„æ ¸å¿ƒéœ€æ±‚ï¼š

1. **âœ… åˆ†ç¦»å¼JSONå¯¼å‡º**ï¼š4ä¸ªä¸“é—¨æ–‡ä»¶ï¼ŒæŒ‰éœ€åŠ è½½
2. **âœ… å˜é‡å…³ç³»å›¾**ï¼šå®Œæ•´çš„èŠ‚ç‚¹ã€è¾¹ã€èšç±»æ•°æ®
3. **âœ… æ€§èƒ½ä¼˜åŒ–**ï¼šæ™ºèƒ½å¤„ç†ç­–ç•¥ï¼Œæ˜¾è‘—æå‡æ•ˆç‡
4. **âœ… å‰ç«¯å‹å¥½**ï¼šç»“æ„åŒ–æ•°æ®æ”¯æŒå¯è§†åŒ–

è¿™ä¸ªå®ç°ä¸ºå¯äº¤äº’çš„Rustè¿è¡Œæ—¶å†…å­˜åˆ†æç•Œé¢æä¾›äº†å¼ºå¤§çš„æ•°æ®åŸºç¡€ï¼Œç‰¹åˆ«æ˜¯å˜é‡å…³ç³»å›¾åŠŸèƒ½å°†å¤§å¤§å¢å¼ºç”¨æˆ·å¯¹å†…å­˜ä½¿ç”¨æ¨¡å¼çš„ç†è§£ã€‚