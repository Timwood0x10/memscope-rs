<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Analysis Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            margin-bottom: 0;
        }
        
        .nav-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .nav-tab.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            background: white;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 8px 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .metric-card.memory { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .metric-card.lifecycle { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .metric-card.performance { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .metric-card.safety { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        
        .metric-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-unit {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .export-buttons {
            margin: 20px 0;
            text-align: right;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: 500;
            transition: transform 0.2s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .hidden {
            display: none;
        }
        
        .allocation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .allocation-table th,
        .allocation-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .allocation-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-active { background: #e8f5e8; color: #2e7d32; }
        .status-freed { background: #fff3e0; color: #ef6c00; }
        .status-leaked { background: #ffebee; color: #c62828; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header>
            <h1>📊 Memory Analysis Dashboard</h1>
            <p>Comprehensive memory usage, lifecycle, and performance analysis for Rust applications</p>
        </header>

        <div class="export-buttons">
            <button class="export-btn" onclick="exportToSVG()">📊 Export SVG</button>
            <button class="export-btn" onclick="exportToJSON()">💾 Export JSON</button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('memory')">Memory Analysis</button>
            <button class="nav-tab" onclick="showTab('lifecycle')">Lifecycle Tracking</button>
            <button class="nav-tab" onclick="showTab('performance')">Performance Metrics</button>
        </div>

        <div id="loading" class="loading">
            Loading memory analysis data...
        </div>

        <div id="dashboard-content" class="tab-content hidden">
            <!-- Memory Analysis Tab -->
            <div id="memory-tab" class="tab-panel">
                <div class="metrics-grid">
                    <div class="metric-card memory">
                        <div class="metric-title">Total Allocations</div>
                        <div class="metric-value" id="total-allocations">0</div>
                        <div class="metric-unit">allocations</div>
                    </div>
                    
                    <div class="metric-card memory">
                        <div class="metric-title">Active Memory</div>
                        <div class="metric-value" id="active-memory">0</div>
                        <div class="metric-unit">bytes</div>
                    </div>
                    
                    <div class="metric-card memory">
                        <div class="metric-title">Peak Memory</div>
                        <div class="metric-value" id="peak-memory">0</div>
                        <div class="metric-unit">bytes</div>
                    </div>
                    
                    <div class="metric-card safety">
                        <div class="metric-title">Memory Efficiency</div>
                        <div class="metric-value" id="memory-efficiency">0</div>
                        <div class="metric-unit">%</div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-title">📈 Memory Usage Over Time</div>
                        <canvas id="memoryTimelineChart" width="400" height="300"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">🥧 Allocation Size Distribution</div>
                        <canvas id="allocationSizeChart" width="400" height="300"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">📋 Recent Allocations</div>
                    <table class="allocation-table">
                        <thead>
                            <tr>
                                <th>Address</th>
                                <th>Size</th>
                                <th>Status</th>
                                <th>Lifetime</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="allocations-table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Lifecycle Tab -->
            <div id="lifecycle-tab" class="tab-panel hidden">
                <div class="metrics-grid">
                    <div class="metric-card lifecycle">
                        <div class="metric-title">Avg Lifetime</div>
                        <div class="metric-value" id="avg-lifetime">0</div>
                        <div class="metric-unit">ms</div>
                    </div>
                    
                    <div class="metric-card lifecycle">
                        <div class="metric-title">Completed Cycles</div>
                        <div class="metric-value" id="completed-cycles">0</div>
                        <div class="metric-unit">cycles</div>
                    </div>
                    
                    <div class="metric-card lifecycle">
                        <div class="metric-title">P99 Lifetime</div>
                        <div class="metric-value" id="p99-lifetime">0</div>
                        <div class="metric-unit">ms</div>
                    </div>
                    
                    <div class="metric-card safety">
                        <div class="metric-title">Memory Leaks</div>
                        <div class="metric-value" id="memory-leaks">0</div>
                        <div class="metric-unit">detected</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">⏱️ Lifetime Distribution</div>
                    <canvas id="lifetimeChart" width="800" height="400"></canvas>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-title">📊 Lifetime Percentiles</div>
                        <canvas id="percentilesChart" width="400" height="300"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">🔄 Allocation Patterns</div>
                        <canvas id="patternsChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div id="performance-tab" class="tab-panel hidden">
                <div class="metrics-grid">
                    <div class="metric-card performance">
                        <div class="metric-title">Alloc Rate</div>
                        <div class="metric-value" id="alloc-rate">0</div>
                        <div class="metric-unit">allocs/sec</div>
                    </div>
                    
                    <div class="metric-card performance">
                        <div class="metric-title">Dealloc Rate</div>
                        <div class="metric-value" id="dealloc-rate">0</div>
                        <div class="metric-unit">deallocs/sec</div>
                    </div>
                    
                    <div class="metric-card performance">
                        <div class="metric-title">Fragmentation</div>
                        <div class="metric-value" id="fragmentation">0</div>
                        <div class="metric-unit">%</div>
                    </div>
                    
                    <div class="metric-card safety">
                        <div class="metric-title">Performance Score</div>
                        <div class="metric-value" id="performance-score">0</div>
                        <div class="metric-unit">/ 100</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">⚡ Performance Timeline</div>
                    <canvas id="performanceChart" width="800" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let charts = {};
        let currentTab = 'memory';

        // Load and initialize dashboard
        async function loadDashboard() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                dashboardData = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').classList.remove('hidden');
                
                updateAllMetrics();
                createAllCharts();
                updateAllocationsTable();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('loading').innerHTML = 
                    '<div style="color: #e74c3c;">Failed to load data. Please ensure data.json is available.</div>';
            }
        }

        // Tab switching
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            currentTab = tabName;
        }

        // Update all metrics
        function updateAllMetrics() {
            if (!dashboardData) return;

            const stats = dashboardData.memory_stats;
            
            // Memory metrics
            document.getElementById('total-allocations').textContent = stats.total_allocations.toLocaleString();
            document.getElementById('active-memory').textContent = formatBytes(stats.active_memory);
            document.getElementById('peak-memory').textContent = formatBytes(stats.peak_memory);
            
            const efficiency = Math.round((stats.total_deallocated / stats.total_allocated) * 100) || 0;
            document.getElementById('memory-efficiency').textContent = efficiency;

            // Lifecycle metrics
            const lifecycle = stats.lifecycle_stats;
            document.getElementById('avg-lifetime').textContent = lifecycle.average_lifetime_ms.toFixed(2);
            document.getElementById('completed-cycles').textContent = lifecycle.completed_allocations.toLocaleString();
            document.getElementById('p99-lifetime').textContent = lifecycle.lifetime_percentiles.p99.toFixed(2);
            
            const leaks = stats.active_allocations - stats.total_deallocations;
            document.getElementById('memory-leaks').textContent = Math.max(0, leaks);

            // Performance metrics
            const duration = dashboardData.memory_timeline?.length || 1;
            const allocRate = Math.round(stats.total_allocations / duration);
            const deallocRate = Math.round(stats.total_deallocations / duration);
            
            document.getElementById('alloc-rate').textContent = allocRate;
            document.getElementById('dealloc-rate').textContent = deallocRate;
            
            const fragmentation = Math.round((1 - (stats.active_memory / stats.peak_memory)) * 100) || 0;
            document.getElementById('fragmentation').textContent = fragmentation;
            
            const perfScore = Math.min(100, Math.round(efficiency * 0.6 + (100 - fragmentation) * 0.4));
            document.getElementById('performance-score').textContent = perfScore;
        }

        // Create all charts
        function createAllCharts() {
            createMemoryTimelineChart();
            createAllocationSizeChart();
            createLifetimeChart();
            createPercentilesChart();
            createPatternsChart();
            createPerformanceChart();
        }

        function createMemoryTimelineChart() {
            const ctx = document.getElementById('memoryTimelineChart').getContext('2d');
            const timeline = dashboardData.memory_timeline || [];
            
            charts.memoryTimeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeline.map((_, i) => `T${i}`),
                    datasets: [
                        {
                            label: 'Active Memory',
                            data: timeline.map(t => t.active_memory || 0),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Allocated',
                            data: timeline.map(t => t.allocated_bytes || 0),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatBytes(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createAllocationSizeChart() {
            const ctx = document.getElementById('allocationSizeChart').getContext('2d');
            
            // Create size buckets
            const buckets = {
                'Small (< 1KB)': 0,
                'Medium (1KB - 64KB)': 0,
                'Large (64KB - 1MB)': 0,
                'Huge (> 1MB)': 0
            };

            // This is simulated data - in real implementation, you'd analyze actual allocation sizes
            const totalAllocs = dashboardData.memory_stats.total_allocations;
            buckets['Small (< 1KB)'] = Math.round(totalAllocs * 0.7);
            buckets['Medium (1KB - 64KB)'] = Math.round(totalAllocs * 0.25);
            buckets['Large (64KB - 1MB)'] = Math.round(totalAllocs * 0.04);
            buckets['Huge (> 1MB)'] = Math.round(totalAllocs * 0.01);

            charts.allocationSize = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(buckets),
                    datasets: [{
                        data: Object.values(buckets),
                        backgroundColor: [
                            '#3498db',
                            '#e74c3c',
                            '#f39c12',
                            '#9b59b6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createLifetimeChart() {
            const ctx = document.getElementById('lifetimeChart').getContext('2d');
            const lifecycle = dashboardData.memory_stats.lifecycle_stats;
            
            // Simulate lifetime distribution data
            const lifetimeData = [];
            for (let i = 0; i < 50; i++) {
                lifetimeData.push(Math.random() * lifecycle.average_lifetime_ms * 2);
            }

            charts.lifetime = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: lifetimeData.map((_, i) => `${i * 10}-${(i + 1) * 10}ms`).slice(0, 10),
                    datasets: [{
                        label: 'Allocation Count',
                        data: lifetimeData.slice(0, 10),
                        backgroundColor: '#4facfe',
                        borderColor: '#00f2fe',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createPercentilesChart() {
            const ctx = document.getElementById('percentilesChart').getContext('2d');
            const percentiles = dashboardData.memory_stats.lifecycle_stats.lifetime_percentiles;
            
            charts.percentiles = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['P50', 'P90', 'P95', 'P99'],
                    datasets: [{
                        label: 'Lifetime (ms)',
                        data: [percentiles.p50, percentiles.p90, percentiles.p95, percentiles.p99],
                        backgroundColor: [
                            '#43e97b',
                            '#38f9d7',
                            '#4facfe',
                            '#00f2fe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createPatternsChart() {
            const ctx = document.getElementById('patternsChart').getContext('2d');
            
            charts.patterns = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['0s', '1s', '2s', '3s', '4s', '5s'],
                    datasets: [{
                        label: 'Allocations/sec',
                        data: [100, 150, 120, 180, 160, 140],
                        borderColor: '#fa709a',
                        backgroundColor: 'rgba(250, 112, 154, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            charts.performance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['0s', '1s', '2s', '3s', '4s', '5s'],
                    datasets: [
                        {
                            label: 'Allocation Rate',
                            data: [100, 150, 120, 180, 160, 140],
                            borderColor: '#43e97b',
                            backgroundColor: 'rgba(67, 233, 123, 0.1)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Memory Usage (MB)',
                            data: [10, 15, 12, 18, 16, 14],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        function updateAllocationsTable() {
            const tbody = document.getElementById('allocations-table-body');
            tbody.innerHTML = '';

            // Simulate recent allocations data
            for (let i = 0; i < 10; i++) {
                const row = document.createElement('tr');
                const status = Math.random() > 0.7 ? 'freed' : 'active';
                const lifetime = Math.random() * 1000;
                
                row.innerHTML = `
                    <td>0x${Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0')}</td>
                    <td>${formatBytes(Math.floor(Math.random() * 10000))}</td>
                    <td><span class="status-badge status-${status}">${status.toUpperCase()}</span></td>
                    <td>${lifetime.toFixed(2)}ms</td>
                    <td>src/main.rs:${Math.floor(Math.random() * 100) + 1}</td>
                `;
                
                tbody.appendChild(row);
            }
        }

        // Utility functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Export functions
        function exportToSVG() {
            const svg = createDashboardSVG();
            downloadFile(svg, 'memory_analysis.svg', 'image/svg+xml');
        }

        function exportToJSON() {
            const jsonStr = JSON.stringify(dashboardData, null, 2);
            downloadFile(jsonStr, 'memory_analysis.json', 'application/json');
        }

        function createDashboardSVG() {
            return `<?xml version="1.0" encoding="UTF-8"?>
<svg width="1200" height="800" xmlns="http://www.w3.org/2000/svg">
    <rect width="1200" height="800" fill="white"/>
    <text x="600" y="50" text-anchor="middle" font-size="28" font-weight="bold" fill="#2c3e50">Memory Analysis Report</text>
    
    <!-- Metrics -->
    <rect x="50" y="100" width="250" height="120" fill="#667eea" rx="8"/>
    <text x="175" y="130" text-anchor="middle" font-size="14" fill="white">TOTAL ALLOCATIONS</text>
    <text x="175" y="160" text-anchor="middle" font-size="32" font-weight="bold" fill="white">${document.getElementById('total-allocations').textContent}</text>
    
    <rect x="320" y="100" width="250" height="120" fill="#f093fb" rx="8"/>
    <text x="445" y="130" text-anchor="middle" font-size="14" fill="white">ACTIVE MEMORY</text>
    <text x="445" y="160" text-anchor="middle" font-size="32" font-weight="bold" fill="white">${document.getElementById('active-memory').textContent}</text>
    
    <rect x="590" y="100" width="250" height="120" fill="#4facfe" rx="8"/>
    <text x="715" y="130" text-anchor="middle" font-size="14" fill="white">PEAK MEMORY</text>
    <text x="715" y="160" text-anchor="middle" font-size="32" font-weight="bold" fill="white">${document.getElementById('peak-memory').textContent}</text>
    
    <rect x="860" y="100" width="250" height="120" fill="#43e97b" rx="8"/>
    <text x="985" y="130" text-anchor="middle" font-size="14" fill="white">EFFICIENCY</text>
    <text x="985" y="160" text-anchor="middle" font-size="32" font-weight="bold" fill="white">${document.getElementById('memory-efficiency').textContent}%</text>
    
    <!-- Chart placeholder -->
    <rect x="50" y="250" width="1100" height="400" fill="#f8f9fa" stroke="#dee2e6" rx="8"/>
    <text x="600" y="460" text-anchor="middle" font-size="18" fill="#666">Memory Usage Timeline Chart</text>
    
    <!-- Footer -->
    <text x="600" y="750" text-anchor="middle" font-size="12" fill="#666">Generated on ${new Date().toLocaleString()}</text>
</svg>`;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize dashboard when page loads
        window.addEventListener('load', loadDashboard);
    </script>
</body>
</html>