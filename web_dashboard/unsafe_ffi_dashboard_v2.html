<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unsafe/FFI Memory Analysis Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #e74c3c;
        }
        
        .metric-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .metric-unit {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .unsafe-operations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .unsafe-operations-table th,
        .unsafe-operations-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .unsafe-operations-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .risk-level {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .risk-high { background-color: #ffebee; color: #c62828; }
        .risk-medium { background-color: #fff3e0; color: #ef6c00; }
        .risk-low { background-color: #e8f5e8; color: #2e7d32; }
        
        .export-buttons {
            margin: 20px 0;
            text-align: right;
        }
        
        .export-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .export-btn:hover {
            background: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header>
            <h1>ðŸ”’ Unsafe/FFI Memory Analysis Dashboard</h1>
            <p>Real-time monitoring of unsafe operations and foreign function interface calls</p>
        </header>

        <div class="export-buttons">
            <button class="export-btn" onclick="exportToSVG()">Export as SVG</button>
            <button class="export-btn" onclick="exportToJSON()">Export as JSON</button>
        </div>

        <div id="loading" class="loading">
            Loading unsafe/FFI analysis data...
        </div>

        <div id="error" class="error" style="display: none;">
            Failed to load data. Please ensure the JSON data file is available.
        </div>

        <div id="dashboard-content" style="display: none;">
            <!-- Key Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">Total Unsafe Operations</div>
                    <div class="metric-value" id="total-unsafe-ops">0</div>
                    <div class="metric-unit">operations</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">FFI Calls</div>
                    <div class="metric-value" id="ffi-calls">0</div>
                    <div class="metric-unit">calls</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Memory Violations</div>
                    <div class="metric-value" id="memory-violations">0</div>
                    <div class="metric-unit">detected</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Risk Score</div>
                    <div class="metric-value" id="risk-score">0</div>
                    <div class="metric-unit">/ 100</div>
                </div>
            </div>

            <!-- Memory Usage Over Time Chart -->
            <div class="chart-container">
                <div class="chart-title">Memory Usage Timeline</div>
                <canvas id="memoryChart" width="400" height="200"></canvas>
            </div>

            <!-- Unsafe Operations Distribution -->
            <div class="chart-container">
                <div class="chart-title">Unsafe Operations Distribution</div>
                <canvas id="unsafeOpsChart" width="400" height="200"></canvas>
            </div>

            <!-- FFI Call Analysis -->
            <div class="chart-container">
                <div class="chart-title">FFI Call Frequency</div>
                <canvas id="ffiChart" width="400" height="200"></canvas>
            </div>

            <!-- Detailed Operations Table -->
            <div class="chart-container">
                <div class="chart-title">Unsafe Operations Details</div>
                <table class="unsafe-operations-table">
                    <thead>
                        <tr>
                            <th>Operation Type</th>
                            <th>Location</th>
                            <th>Memory Address</th>
                            <th>Size</th>
                            <th>Risk Level</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="operations-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let charts = {};

        // Load and initialize dashboard
        async function loadDashboard() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                dashboardData = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                
                updateMetrics();
                createCharts();
                updateOperationsTable();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        // Update key metrics
        function updateMetrics() {
            if (!dashboardData || !dashboardData.unsafe_ffi_data) return;

            const unsafeData = dashboardData.unsafe_ffi_data;
            
            // Calculate metrics
            const totalUnsafeOps = unsafeData.unsafe_operations ? unsafeData.unsafe_operations.length : 0;
            const ffiCalls = unsafeData.ffi_calls ? unsafeData.ffi_calls.length : 0;
            const memoryViolations = unsafeData.memory_violations ? unsafeData.memory_violations.length : 0;
            
            // Calculate risk score based on violations and operations
            const riskScore = Math.min(100, Math.round(
                (memoryViolations * 30 + totalUnsafeOps * 2 + ffiCalls * 1) / 10
            ));

            document.getElementById('total-unsafe-ops').textContent = totalUnsafeOps;
            document.getElementById('ffi-calls').textContent = ffiCalls;
            document.getElementById('memory-violations').textContent = memoryViolations;
            document.getElementById('risk-score').textContent = riskScore;
        }

        // Create charts
        function createCharts() {
            if (!dashboardData) return;

            createMemoryChart();
            createUnsafeOpsChart();
            createFFIChart();
        }

        // Memory usage timeline chart
        function createMemoryChart() {
            const ctx = document.getElementById('memoryChart').getContext('2d');
            
            // Extract memory data from timeline
            const memoryData = dashboardData.memory_timeline || [];
            const labels = memoryData.map((_, index) => `T${index}`);
            const allocatedData = memoryData.map(point => point.allocated_bytes || 0);
            const deallocatedData = memoryData.map(point => point.deallocated_bytes || 0);

            charts.memoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Allocated Memory',
                            data: allocatedData,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Deallocated Memory',
                            data: deallocatedData,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Bytes'
                            }
                        }
                    }
                }
            });
        }

        // Unsafe operations distribution chart
        function createUnsafeOpsChart() {
            const ctx = document.getElementById('unsafeOpsChart').getContext('2d');
            
            const unsafeOps = dashboardData.unsafe_ffi_data?.unsafe_operations || [];
            const opTypes = {};
            
            unsafeOps.forEach(op => {
                const type = op.operation_type || 'Unknown';
                opTypes[type] = (opTypes[type] || 0) + 1;
            });

            charts.unsafeOpsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(opTypes),
                    datasets: [{
                        data: Object.values(opTypes),
                        backgroundColor: [
                            '#e74c3c',
                            '#f39c12',
                            '#9b59b6',
                            '#3498db',
                            '#1abc9c',
                            '#95a5a6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // FFI calls chart
        function createFFIChart() {
            const ctx = document.getElementById('ffiChart').getContext('2d');
            
            const ffiCalls = dashboardData.unsafe_ffi_data?.ffi_calls || [];
            const callFrequency = {};
            
            ffiCalls.forEach(call => {
                const func = call.function_name || 'Unknown';
                callFrequency[func] = (callFrequency[func] || 0) + 1;
            });

            const labels = Object.keys(callFrequency).slice(0, 10); // Top 10
            const data = labels.map(label => callFrequency[label]);

            charts.ffiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Call Count',
                        data: data,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update operations table
        function updateOperationsTable() {
            const tbody = document.getElementById('operations-table-body');
            tbody.innerHTML = '';

            const unsafeOps = dashboardData.unsafe_ffi_data?.unsafe_operations || [];
            
            unsafeOps.slice(0, 50).forEach(op => { // Show first 50 operations
                const row = document.createElement('tr');
                
                const riskLevel = determineRiskLevel(op);
                
                row.innerHTML = `
                    <td>${op.operation_type || 'Unknown'}</td>
                    <td>${op.location || 'N/A'}</td>
                    <td>${op.memory_address || 'N/A'}</td>
                    <td>${op.size || 'N/A'} bytes</td>
                    <td><span class="risk-level risk-${riskLevel.toLowerCase()}">${riskLevel}</span></td>
                    <td>${new Date(op.timestamp || Date.now()).toLocaleString()}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Determine risk level for an operation
        function determineRiskLevel(operation) {
            // Simple risk assessment logic
            if (operation.operation_type?.includes('deref') || operation.operation_type?.includes('write')) {
                return 'High';
            } else if (operation.operation_type?.includes('read')) {
                return 'Medium';
            }
            return 'Low';
        }

        // Export functions
        function exportToSVG() {
            // Create SVG export of the dashboard
            const svg = createDashboardSVG();
            downloadFile(svg, 'unsafe_ffi_analysis.svg', 'image/svg+xml');
        }

        function exportToJSON() {
            // Export current dashboard data
            const jsonStr = JSON.stringify(dashboardData, null, 2);
            downloadFile(jsonStr, 'unsafe_ffi_analysis.json', 'application/json');
        }

        function createDashboardSVG() {
            // Simple SVG export - in a real implementation, you'd convert charts to SVG
            return `<?xml version="1.0" encoding="UTF-8"?>
<svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
    <rect width="800" height="600" fill="white"/>
    <text x="400" y="50" text-anchor="middle" font-size="24" font-weight="bold">Unsafe/FFI Analysis Report</text>
    <text x="50" y="100" font-size="16">Total Unsafe Operations: ${document.getElementById('total-unsafe-ops').textContent}</text>
    <text x="50" y="130" font-size="16">FFI Calls: ${document.getElementById('ffi-calls').textContent}</text>
    <text x="50" y="160" font-size="16">Memory Violations: ${document.getElementById('memory-violations').textContent}</text>
    <text x="50" y="190" font-size="16">Risk Score: ${document.getElementById('risk-score').textContent}</text>
</svg>`;
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize dashboard when page loads
        window.addEventListener('load', loadDashboard);
    </script>
</body>
</html>