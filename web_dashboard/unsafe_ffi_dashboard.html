<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶Ä Unsafe/FFI Memory Analysis Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            color: #ecf0f1;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header .subtitle {
            font-size: 1rem;
            color: #bdc3c7;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* KPI Dashboard Section */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .kpi-card h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #3498db;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kpi-content {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .kpi-highlight {
            color: #e74c3c;
            font-weight: bold;
        }

        /* Memory Safety Status Section */
        .safety-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #e74c3c;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .violation-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .violation-card {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .violation-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .violation-details {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .violation-details .detail-line {
            margin-bottom: 5px;
        }

        .violation-details .highlight {
            color: #f39c12;
            font-weight: bold;
        }

        /* Cross-Language Memory Flow Section */
        .flow-section {
            margin-bottom: 30px;
        }

        .flow-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            gap: 30px;
        }

        .flow-box {
            background: rgba(52, 152, 219, 0.2);
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            min-width: 120px;
            font-weight: bold;
        }

        .flow-arrow {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .arrow {
            font-size: 2rem;
            color: #3498db;
        }

        .arrow-label {
            font-size: 0.8rem;
            color: #bdc3c7;
            text-align: center;
        }

        .flow-summary {
            margin-top: 20px;
            padding: 15px;
            background: rgba(241, 196, 15, 0.1);
            border: 1px solid #f1c40f;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Allocation Details Section */
        .allocation-section {
            margin-bottom: 30px;
        }

        .allocation-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .stats-part, .hotspot-part {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
        }

        .stats-part h4, .hotspot-part h4 {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #3498db;
        }

        .stat-bar {
            margin-bottom: 15px;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .stat-progress {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.5s ease;
        }

        .hotspot-table {
            width: 100%;
            border-collapse: collapse;
        }

        .hotspot-table th,
        .hotspot-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hotspot-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            color: #3498db;
        }

        /* Controls */
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn.export {
            background: #27ae60;
        }

        .btn.export:hover {
            background: #229954;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #bdc3c7;
        }

        .error {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #e74c3c;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .allocation-container {
                grid-template-columns: 1fr;
            }
            
            .flow-diagram {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>ü¶Ä Unsafe/FFI Memory Analysis</h1>
            <div class="subtitle">Real-time Memory Safety Dashboard</div>
        </div>

        <div class="controls">
            <button class="btn" onclick="loadData()">üîÑ Refresh Data</button>
            <button class="btn export" onclick="exportSVG()">üìä Export as SVG</button>
            <input type="file" id="jsonFile" accept=".json" style="display: none;" onchange="loadFromFile(event)">
            <button class="btn" onclick="document.getElementById('jsonFile').click()">üìÅ Load JSON</button>
        </div>

        <div id="dashboard-content" class="loading">
            Loading dashboard data...
        </div>
    </div>

    <script>
        let dashboardData = null;

        // Load data from JSON file
        async function loadData() {
            try {
                const response = await fetch('dashboard_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                dashboardData = await response.json();
                renderDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('dashboard-content').innerHTML = `
                    <div class="error">
                        ‚ùå Failed to load dashboard data<br>
                        <small>Make sure dashboard_data.json exists and is accessible</small><br>
                        <small>Error: ${error.message}</small>
                    </div>
                `;
            }
        }

        // Load data from file input
        function loadFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    dashboardData = JSON.parse(e.target.result);
                    renderDashboard();
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    document.getElementById('dashboard-content').innerHTML = `
                        <div class="error">
                            ‚ùå Invalid JSON file<br>
                            <small>Error: ${error.message}</small>
                        </div>
                    `;
                }
            };
            reader.readAsText(file);
        }

        // Render the complete dashboard
        function renderDashboard() {
            if (!dashboardData) return;

            const content = `
                ${renderKPISection()}
                ${renderSafetySection()}
                ${renderFlowSection()}
                ${renderAllocationSection()}
            `;

            document.getElementById('dashboard-content').innerHTML = content;
        }

        // Render KPI Dashboard Section
        function renderKPISection() {
            const metrics = dashboardData.metrics;
            
            // Calculate stats by source
            const unsafeStats = calculateSourceStats('UnsafeRust');
            const ffiStats = calculateSourceStats('FfiC');
            const boundaryStats = calculateBoundaryStats();
            const violationStats = calculateViolationStats();

            return `
                <div class="kpi-section">
                    <div class="kpi-card">
                        <h3>Unsafe Rust</h3>
                        <div class="kpi-content">
                            Allocations: ${unsafeStats.count}<br>
                            Total Memory: ${formatBytes(unsafeStats.memory)}<br>
                            Leaks: ${unsafeStats.leaks} (${formatBytes(unsafeStats.leakMemory)})
                        </div>
                    </div>
                    <div class="kpi-card">
                        <h3>FFI/C</h3>
                        <div class="kpi-content">
                            Allocations: ${ffiStats.count}<br>
                            Total Memory: ${formatBytes(ffiStats.memory)}<br>
                            Leaks: <span class="kpi-highlight">${ffiStats.leaks} (${formatBytes(ffiStats.leakMemory)})</span>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <h3>Boundary Crossings</h3>
                        <div class="kpi-content">
                            Rust ‚Üí C: ${boundaryStats.rustToC}<br>
                            C ‚Üí Rust: ${boundaryStats.cToRust}<br>
                            Total Events: ${metrics.boundary_crossings}
                        </div>
                    </div>
                    <div class="kpi-card">
                        <h3>Safety Violations</h3>
                        <div class="kpi-content">
                            Count: <span class="kpi-highlight">${metrics.safety_violations}</span><br>
                            Types: ${violationStats.types.join(', ')}<br>
                            Severity: ${violationStats.maxSeverity}
                        </div>
                    </div>
                </div>
            `;
        }

        // Render Memory Safety Status Section
        function renderSafetySection() {
            const violations = dashboardData.violations;
            
            if (violations.length === 0) {
                return `
                    <div class="safety-section">
                        <h2 class="section-title">Memory Safety Status</h2>
                        <div style="text-align: center; padding: 30px; color: #27ae60; font-size: 1.2rem;">
                            ‚úÖ No safety violations detected
                        </div>
                    </div>
                `;
            }

            const violationCards = violations.map(violation => `
                <div class="violation-card">
                    <div class="violation-title">
                        [${violation.violation_type.toUpperCase()}] ${violation.description}
                    </div>
                    <div class="violation-details">
                        <div class="detail-line">
                            <strong>Severity:</strong> <span class="highlight">${violation.severity}</span>
                        </div>
                        <div class="detail-line">
                            <strong>Timestamp:</strong> ${new Date(violation.timestamp).toLocaleString()}
                        </div>
                        <div class="detail-line">
                            <strong>Affected Memory:</strong> ${violation.affected_memory.map(addr => `0x${addr.toString(16)}`).join(', ')}
                        </div>
                        ${violation.call_stack.length > 0 ? `
                            <div class="detail-line">
                                <strong>Call Stack:</strong><br>
                                ${violation.call_stack.map(frame => 
                                    `&nbsp;&nbsp;‚Ä¢ ${frame.function_name}${frame.file_name ? ` (${frame.file_name}:${frame.line_number || '?'})` : ''}`
                                ).join('<br>')}
                            </div>
                        ` : ''}
                        ${violation.mitigation_suggestions.length > 0 ? `
                            <div class="detail-line">
                                <strong>Suggestions:</strong><br>
                                ${violation.mitigation_suggestions.map(suggestion => `&nbsp;&nbsp;‚Ä¢ ${suggestion}`).join('<br>')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            return `
                <div class="safety-section">
                    <h2 class="section-title">Memory Safety Violations & Leak Report</h2>
                    <div class="violation-list">
                        ${violationCards}
                    </div>
                </div>
            `;
        }

        // Render Cross-Language Memory Flow Section
        function renderFlowSection() {
            const boundaryStats = calculateBoundaryStats();
            const isAsymmetric = boundaryStats.rustToC !== boundaryStats.cToRust;
            
            return `
                <div class="flow-section">
                    <h2 class="section-title">Cross-Language Memory Flow</h2>
                    <div class="flow-container">
                        <div class="flow-diagram">
                            <div class="flow-box">RUST</div>
                            <div class="flow-arrow">
                                <div class="arrow">‚Üí</div>
                                <div class="arrow-label">
                                    Count: ${boundaryStats.rustToC}<br>
                                    Total Size: ${formatBytes(boundaryStats.rustToCMemory)}
                                </div>
                            </div>
                            <div class="flow-box">FFI/C</div>
                            <div class="flow-arrow">
                                <div class="arrow">‚Üê</div>
                                <div class="arrow-label">
                                    Count: ${boundaryStats.cToRust}<br>
                                    Total Size: ${formatBytes(boundaryStats.cToRustMemory)}
                                </div>
                            </div>
                        </div>
                        <div class="flow-summary">
                            <strong>Net Result:</strong> 
                            ${isAsymmetric ? 
                                `‚ö†Ô∏è Asymmetric flow detected. ${Math.abs(boundaryStats.rustToC - boundaryStats.cToRust)} allocation(s) may indicate potential leaks.` :
                                `‚úÖ Balanced flow. Memory transfers appear symmetric.`
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // Render Unsafe & FFI Allocation Details Section
        function renderAllocationSection() {
            const unsafeStats = calculateSourceStats('UnsafeRust');
            const ffiStats = calculateSourceStats('FfiC');
            const hotspots = calculateHotspots();
            
            const maxMemory = Math.max(unsafeStats.memory, ffiStats.memory);
            
            return `
                <div class="allocation-section">
                    <h2 class="section-title">Unsafe & FFI Allocation Breakdown</h2>
                    <div class="allocation-container">
                        <div class="stats-part">
                            <h4>Source Statistics</h4>
                            <div class="stat-bar">
                                <div class="stat-label">
                                    <span>FFI/C</span>
                                    <span>${formatBytes(ffiStats.memory)} | Count: ${ffiStats.count} | Leaks: ${ffiStats.leaks} (${ffiStats.count > 0 ? Math.round(ffiStats.leaks / ffiStats.count * 100) : 0}%)</span>
                                </div>
                                <div class="stat-progress">
                                    <div class="stat-fill" style="width: ${maxMemory > 0 ? (ffiStats.memory / maxMemory * 100) : 0}%; background: linear-gradient(90deg, #e74c3c, #c0392b);"></div>
                                </div>
                            </div>
                            <div class="stat-bar">
                                <div class="stat-label">
                                    <span>Unsafe Rust</span>
                                    <span>${formatBytes(unsafeStats.memory)} | Count: ${unsafeStats.count} | Leaks: ${unsafeStats.leaks} (${unsafeStats.count > 0 ? Math.round(unsafeStats.leaks / unsafeStats.count * 100) : 0}%)</span>
                                </div>
                                <div class="stat-progress">
                                    <div class="stat-fill" style="width: ${maxMemory > 0 ? (unsafeStats.memory / maxMemory * 100) : 0}%;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="hotspot-part">
                            <h4>Hotspot Functions</h4>
                            <table class="hotspot-table">
                                <thead>
                                    <tr>
                                        <th>Function</th>
                                        <th>Source</th>
                                        <th>Allocations</th>
                                        <th>Total Memory</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${hotspots.map(hotspot => `
                                        <tr>
                                            <td>${hotspot.function}</td>
                                            <td>${hotspot.source}</td>
                                            <td>${hotspot.count}</td>
                                            <td>${formatBytes(hotspot.memory)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper functions
        function calculateSourceStats(sourceType) {
            const allocations = dashboardData.allocations.filter(alloc => 
                alloc.source_type === sourceType
            );
            
            const activeAllocations = allocations.filter(alloc => alloc.is_active);
            const leakedAllocations = allocations.filter(alloc => 
                alloc.is_active && alloc.safety_issues.includes('leak')
            );
            
            return {
                count: allocations.length,
                memory: allocations.reduce((sum, alloc) => sum + alloc.size, 0),
                leaks: leakedAllocations.length,
                leakMemory: leakedAllocations.reduce((sum, alloc) => sum + alloc.size, 0)
            };
        }

        function calculateBoundaryStats() {
            const events = dashboardData.boundary_events;
            const rustToC = events.filter(e => e.from_context.includes('Rust') && e.to_context.includes('C')).length;
            const cToRust = events.filter(e => e.from_context.includes('C') && e.to_context.includes('Rust')).length;
            const rustToCMemory = events
                .filter(e => e.from_context.includes('Rust') && e.to_context.includes('C'))
                .reduce((sum, e) => sum + e.memory_size, 0);
            const cToRustMemory = events
                .filter(e => e.from_context.includes('C') && e.to_context.includes('Rust'))
                .reduce((sum, e) => sum + e.memory_size, 0);
            
            return { rustToC, cToRust, rustToCMemory, cToRustMemory };
        }

        function calculateViolationStats() {
            const violations = dashboardData.violations;
            const types = [...new Set(violations.map(v => v.violation_type))];
            const severities = violations.map(v => v.severity);
            const maxSeverity = severities.includes('Critical') ? 'Critical' : 
                               severities.includes('High') ? 'High' :
                               severities.includes('Medium') ? 'Medium' : 'Low';
            
            return { types, maxSeverity };
        }

        function calculateHotspots() {
            const functionStats = new Map();
            
            dashboardData.allocations.forEach(alloc => {
                const funcName = alloc.source_details.function_name || 'unknown';
                const sourceType = alloc.source_type === 'UnsafeRust' ? 'Unsafe' : 
                                 alloc.source_type === 'FfiC' ? 'FFI' : 'Safe';
                const key = `${funcName}|${sourceType}`;
                
                if (!functionStats.has(key)) {
                    functionStats.set(key, {
                        function: funcName,
                        source: sourceType,
                        count: 0,
                        memory: 0
                    });
                }
                
                const stats = functionStats.get(key);
                stats.count++;
                stats.memory += alloc.size;
            });
            
            return Array.from(functionStats.values())
                .sort((a, b) => b.memory - a.memory)
                .slice(0, 5);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + sizes[i];
        }

        // Export to SVG
        function exportSVG() {
            if (!dashboardData) {
                alert('No data to export. Please load data first.');
                return;
            }
            
            // Create SVG content based on current dashboard
            const svgContent = generateSVGDashboard();
            
            // Download SVG
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'unsafe_ffi_dashboard.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateSVGDashboard() {
            // This would generate an SVG version of the dashboard
            // For now, return a simple placeholder
            return `<?xml version="1.0" encoding="UTF-8"?>
<svg width="1400" height="1000" xmlns="http://www.w3.org/2000/svg">
    <rect width="100%" height="100%" fill="#2c3e50"/>
    <text x="700" y="50" text-anchor="middle" fill="white" font-size="24" font-family="Arial">
        Unsafe/FFI Memory Analysis Dashboard
    </text>
    <text x="700" y="500" text-anchor="middle" fill="#bdc3c7" font-size="16" font-family="Arial">
        SVG export functionality - Dashboard data exported at ${new Date().toLocaleString()}
    </text>
</svg>`;
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });
    </script>
</body>
</html>