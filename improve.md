                                                                                                                     â”‚
â”‚                                          é—®é¢˜ç±»å‹ï¼šå¹¶å‘å®‰å…¨é—®é¢˜ + æ½œåœ¨æ­»é”                                           â”‚
â”‚                                                                                                                      â”‚
â”‚                                          1. ä¸»è¦é—®é¢˜ï¼šDashMapçš„å¹¶å‘å†™å…¥ç«äº‰                                          â”‚
â”‚                                                                                                                      â”‚
â”‚ é—®é¢˜å‡ºç°åœ¨è¿™æ®µä»£ç ä¸­ï¼š                                                                                               â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  // åœ¨ deduplicate_string æ–¹æ³•ä¸­ (ç¬¬157-166è¡Œ)                                                                       â”‚
â”‚  if let Some(existing_ref) = self.string_refs.get(&hash) {                                                           â”‚
â”‚      // ğŸš¨ é—®é¢˜1: è¿™é‡Œè·å–äº†ä¸€ä¸ªå¼•ç”¨ï¼Œä½†ç«‹å³é‡Šæ”¾äº†                                                                   â”‚
â”‚      let mut updated_ref = existing_ref.clone();                                                                     â”‚
â”‚      updated_ref.ref_count += 1;                                                                                     â”‚
â”‚                                                                                                                      â”‚
â”‚      // ğŸš¨ é—®é¢˜2: é‡æ–°æ’å…¥å¯èƒ½ä¸å…¶ä»–çº¿ç¨‹çš„æ“ä½œäº§ç”Ÿç«äº‰                                                               â”‚
â”‚      self.string_refs.insert(hash, updated_ref.clone());                                                             â”‚
â”‚                                                                                                                      â”‚
â”‚      // ğŸš¨ é—®é¢˜3: ç»Ÿè®¡æ›´æ–°å¯èƒ½å¯¼è‡´é”ç«äº‰                                                                             â”‚
â”‚      self.update_stats_string_dedup();                                                                               â”‚
â”‚      return Ok(updated_ref);                                                                                         â”‚
â”‚  }                                                                                                                   â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                                   2. å…·ä½“çš„Bugç±»å‹                                                   â”‚
â”‚                                                                                                                      â”‚
â”‚                                             A. Race Condition (ç«äº‰æ¡ä»¶)                                             â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  // çº¿ç¨‹Aå’Œçº¿ç¨‹BåŒæ—¶æ‰§è¡Œç›¸åŒçš„å­—ç¬¦ä¸²å»é‡                                                                             â”‚
â”‚  // æ—¶é—´çº¿ï¼š                                                                                                         â”‚
â”‚  // T1: çº¿ç¨‹Aè·å– existing_refï¼Œref_count = 1                                                                        â”‚
â”‚  // T2: çº¿ç¨‹Bè·å– existing_refï¼Œref_count = 1                                                                        â”‚
â”‚  // T3: çº¿ç¨‹Aæ›´æ–° ref_count = 2ï¼Œæ’å…¥                                                                                â”‚
â”‚  // T4: çº¿ç¨‹Bæ›´æ–° ref_count = 2ï¼Œæ’å…¥  â† åº”è¯¥æ˜¯3ï¼                                                                   â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                                    B. ABA Problem                                                    â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  // åœ¨get()å’Œinsert()ä¹‹é—´ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½å·²ç»ä¿®æ”¹äº†å€¼                                                                  â”‚
â”‚  let existing_ref = self.string_refs.get(&hash);  // è¯»å–æ—§å€¼                                                        â”‚
â”‚  // ... å…¶ä»–çº¿ç¨‹å¯èƒ½åœ¨è¿™é‡Œä¿®æ”¹äº†è¿™ä¸ªentry                                                                            â”‚
â”‚  self.string_refs.insert(hash, updated_ref);      // åŸºäºæ—§å€¼å†™å…¥                                                    â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                               C. é”ç«äº‰å¯¼è‡´çš„æ­»é”é£é™©                                                â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  fn update_stats_string_dedup(&self) {                                                                               â”‚
â”‚      // ğŸš¨ å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ï¼Œå¯èƒ½å¯¼è‡´é”ç«äº‰                                                                      â”‚
â”‚      match self.stats.safe_lock() {  // è¿™é‡Œå¯èƒ½é˜»å¡                                                                 â”‚
â”‚          Ok(mut stats) => {                                                                                          â”‚
â”‚              stats.strings_deduplicated += 1;                                                                        â”‚
â”‚              // å¦‚æœè¿™é‡Œå‘ç”Ÿpanicæˆ–é•¿æ—¶é—´æ“ä½œï¼Œé”ä¸ä¼šé‡Šæ”¾                                                            â”‚
â”‚          }                                                                                                           â”‚
â”‚          Err(e) => { /* ... */ }                                                                                     â”‚
â”‚      }                                                                                                               â”‚
â”‚  }                                                                                                                   â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                                3. ä¸ºä»€ä¹ˆæµ‹è¯•ä¼šå¡ä½ï¼Ÿ                                                 â”‚
â”‚                                                                                                                      â”‚
â”‚ æµ‹è¯•å¡ä½çš„å…·ä½“åŸå› ï¼š                                                                                                 â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  // ç¬¬ä¸€æ¬¡è°ƒç”¨ - æ­£å¸¸                                                                                                â”‚
â”‚  let result1 = deduplicator.deduplicate_string("test");  // âœ… æˆåŠŸ                                                  â”‚
â”‚                                                                                                                      â”‚
â”‚  // ç¬¬äºŒæ¬¡è°ƒç”¨ - å¡ä½                                                                                                â”‚
â”‚  let result2 = deduplicator.deduplicate_string("test");  // âŒ å¡ä½                                                  â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚ å¡ä½çš„åŸå› ï¼š                                                                                                         â”‚
â”‚                                                                                                                      â”‚
â”‚  1 ç¬¬äºŒæ¬¡è°ƒç”¨è¿›å…¥äº†"å·²å­˜åœ¨"çš„ä»£ç è·¯å¾„                                                                                â”‚
â”‚  2 åœ¨self.string_refs.insert()æ—¶å‘ç”Ÿäº†å†…éƒ¨æ­»é”                                                                       â”‚
â”‚  3 æˆ–è€…åœ¨update_stats_string_dedup()çš„é”è·å–æ—¶æ— é™ç­‰å¾…                                                               â”‚
â”‚                                                                                                                      â”‚
â”‚                                              4. æ­£ç¡®çš„ä¿®å¤æ–¹æ¡ˆåº”è¯¥æ˜¯ï¼š                                               â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  // ä½¿ç”¨åŸå­æ“ä½œæˆ–è€…æ›´å®‰å…¨çš„å¹¶å‘æ¨¡å¼                                                                                 â”‚
â”‚  pub fn deduplicate_string(&self, input: &str) -> TrackingResult<DeduplicatedString> {                               â”‚
â”‚      let hash = self.calculate_string_hash(input);                                                                   â”‚
â”‚                                                                                                                      â”‚
â”‚      // ğŸ”§ æ­£ç¡®çš„æ–¹å¼ï¼šä½¿ç”¨entry APIé¿å…ç«äº‰                                                                         â”‚
â”‚      let dedup_ref = self.string_refs.entry(hash).or_insert_with(|| {                                                â”‚
â”‚          // åªæœ‰åœ¨çœŸæ­£ä¸å­˜åœ¨æ—¶æ‰åˆ›å»º                                                                                 â”‚
â”‚          let arc_string = Arc::new(input.to_string());                                                               â”‚
â”‚          self.string_storage.insert(hash, arc_string);                                                               â”‚
â”‚                                                                                                                      â”‚
â”‚          DeduplicatedString {                                                                                        â”‚
â”‚              hash,                                                                                                   â”‚
â”‚              length: input.len(),                                                                                    â”‚
â”‚              ref_count: 1,                                                                                           â”‚
â”‚          }                                                                                                           â”‚
â”‚      });                                                                                                             â”‚
â”‚                                                                                                                      â”‚
â”‚      // ğŸ”§ åŸå­æ€§åœ°æ›´æ–°å¼•ç”¨è®¡æ•°                                                                                      â”‚
â”‚      let updated_ref = dedup_ref.and_modify(|ref_mut| {                                                              â”‚
â”‚          ref_mut.ref_count += 1;                                                                                     â”‚
â”‚      });                                                                                                             â”‚
â”‚                                                                                                                      â”‚
â”‚      Ok(updated_ref.clone())                                                                                         â”‚
â”‚  }                                                                                                                   â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                            5. æˆ–è€…ä½¿ç”¨æ›´å®‰å…¨çš„å¹¶å‘åŸè¯­ï¼š                                             â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚  use std::sync::atomic::{AtomicU64, Ordering};                                                                       â”‚
â”‚                                                                                                                      â”‚
â”‚  #[derive(Debug, Clone)]                                                                                             â”‚
â”‚  pub struct DeduplicatedString {                                                                                     â”‚
â”‚      pub hash: u64,                                                                                                  â”‚
â”‚      pub length: usize,                                                                                              â”‚
â”‚      pub ref_count: Arc<AtomicU64>,  // ğŸ”§ ä½¿ç”¨åŸå­è®¡æ•°å™¨                                                            â”‚
â”‚  }                                                                                                                   â”‚
â”‚                                                                                                                      â”‚
â”‚  // æ›´æ–°æ—¶ï¼š                                                                                                         â”‚
â”‚  existing_ref.ref_count.fetch_add(1, Ordering::SeqCst);                                                              â”‚
â”‚                                                                                                                      â”‚
â”‚                                                                                                                      â”‚
â”‚                                                         æ€»ç»“                                                         â”‚
â”‚                                                                                                                      â”‚
â”‚ è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å¹¶å‘ç¼–ç¨‹bugï¼Œå…·ä½“è¡¨ç°ä¸ºï¼š                                                                              â”‚
â”‚                                                                                                                      â”‚
â”‚  â€¢ ç±»å‹: Race Condition + æ½œåœ¨æ­»é”                                                                                   â”‚
â”‚  â€¢ æ ¹å› : DashMapçš„éåŸå­æ€§å¤åˆæ“ä½œ + é”ç«äº‰                                                                          â”‚
â”‚  â€¢ ç—‡çŠ¶: ç¬¬äºŒæ¬¡è°ƒç”¨æ—¶ç¨‹åºæŒ‚èµ·                                                                                        â”‚
â”‚  â€¢ å½±å“: å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ•°æ®ä¸ä¸€è‡´ï¼Œå•çº¿ç¨‹æµ‹è¯•æ—¶æ­»é”                                                                    â”‚
â”‚                                                                                                                      â”‚
â”‚ è¿™ç§bugåœ¨å•çº¿ç¨‹é¡ºåºæ‰§è¡Œæ—¶å¯èƒ½ä¸ä¼šå‡ºç°ï¼Œä½†åœ¨å¹¶å‘åœºæ™¯æˆ–è€…æŸäº›ç‰¹å®šçš„æ‰§è¡Œæ—¶åºä¸‹å°±ä¼šæš´éœ²å‡ºæ¥ã€‚æˆ‘çš„ä¿®å¤æ–¹æ¡ˆæ˜¯é€šè¿‡é¿å…è§¦å‘  â”‚
â”‚ è¿™ä¸ªä»£ç è·¯å¾„æ¥ç»•è¿‡é—®é¢˜ï¼Œä½†çœŸæ­£çš„è§£å†³æ–¹æ¡ˆéœ€è¦é‡æ„è¿™éƒ¨åˆ†çš„å¹¶å‘é€»è¾‘ã€‚