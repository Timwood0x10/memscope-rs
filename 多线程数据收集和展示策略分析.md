# å¤šçº¿ç¨‹æ•°æ®æ”¶é›†å’Œå±•ç¤ºç­–ç•¥åˆ†æ

## ğŸ“Š **æ•°æ®æ”¶é›†æ¶æ„**

### **1. æ•°æ®æºå±‚ (Data Source Layer)**
```
Rust Thread 1  â†’  track_var!(variable_name)  â†’  VariableRegistry
Rust Thread 2  â†’  track_var!(variable_name)  â†’  VariableRegistry  
Rust Thread N  â†’  track_var!(variable_name)  â†’  VariableRegistry
                                                       â†“
                                              Global Memory Tracker
```

**å…³é”®ç‰¹ç‚¹ï¼š**
- æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹æ”¶é›†å˜é‡è¿½è¸ªæ•°æ®
- ä½¿ç”¨ `track_var!` å®è‡ªåŠ¨æ•è·å˜é‡ä¿¡æ¯
- å…¨å±€ `VariableRegistry` ç»Ÿä¸€ç®¡ç†æ‰€æœ‰çº¿ç¨‹æ•°æ®
- çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ç¡®ä¿å¹¶å‘è®¿é—®

### **2. æ•°æ®ç»“æ„è®¾è®¡**

#### **åŸå§‹æ•°æ®ç»“æ„ (Rust)**
```rust
struct VariableInfo {
    var_name: String,        // å˜é‡åç§°
    type_name: String,       // ç±»å‹ä¿¡æ¯
    thread_id: usize,        // çº¿ç¨‹ID
    memory_usage: u64,       // å†…å­˜ä½¿ç”¨é‡(å­—èŠ‚)
    lifecycle_stage: String, // ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ
}
```

#### **å±•ç¤ºæ•°æ®ç»“æ„ (JavaScript)**
```javascript
{
    name: String,      // å˜é‡åç§°
    size: Number,      // å†…å­˜å¤§å°(å­—èŠ‚)  
    thread: Number,    // çº¿ç¨‹ID
    state: String,     // çŠ¶æ€ (Active/Allocated/Shared)
    allocs: Number     // åˆ†é…æ¬¡æ•°
}
```

## ğŸ”„ **æ•°æ®è½¬æ¢æµç¨‹**

### **ç¬¬ä¸€é˜¶æ®µï¼šæ”¶é›† (Collection)**
1. **çº¿ç¨‹çº§æ”¶é›†**ï¼šæ¯ä¸ªå·¥ä½œçº¿ç¨‹æ‰§è¡Œä¸åŒç±»å‹çš„å·¥ä½œè´Ÿè½½
   - IOBound: 1500 operations (ç½‘ç»œç¼“å†²åŒºã€æ–‡ä»¶ç¼“å­˜)
   - CPUBound: 2000 operations (çŸ©é˜µè®¡ç®—ã€å“ˆå¸ŒçŠ¶æ€)
   - MemoryBound: 800 operations (å›¾åƒå¤„ç†ã€æ•°æ®åº“ç´¢å¼•)
   - Interactive: 1200 operations (HTTPè¯·æ±‚ã€JSONå“åº”)

2. **è‡ªåŠ¨è¿½è¸ª**ï¼šé€šè¿‡ `track_var!` å®è‡ªåŠ¨æ•è·ï¼š
   ```rust
   let network_recv_buffer = vec![...];
   track_var!(network_recv_buffer);  // è‡ªåŠ¨æ³¨å†Œåˆ°å…¨å±€è¿½è¸ªå™¨
   ```

### **ç¬¬äºŒé˜¶æ®µï¼šèšåˆ (Aggregation)**
```rust
// ä»æ‰€æœ‰çº¿ç¨‹æ”¶é›†æ•°æ®
let real_variables = VariableRegistry::get_all_variables();

// æŒ‰çº¿ç¨‹åˆ†ç»„ç»Ÿè®¡
for variable in real_variables.values() {
    let thread_id = variable.thread_id;
    // ç´¯ç§¯çº¿ç¨‹ç»Ÿè®¡
    thread_stats[thread_id].total_allocations += 1;
    thread_stats[thread_id].peak_memory += variable.memory_usage;
}
```

### **ç¬¬ä¸‰é˜¶æ®µï¼šè½¬æ¢ (Transformation)**
```rust
// è½¬æ¢ä¸ºå‰ç«¯æ•°æ®ç»“æ„
let variable_details = real_variables.into_iter().map(|(addr, var_info)| {
    VariableDetail {
        name: var_info.var_name,
        thread_id: var_info.thread_id,
        memory_usage: var_info.memory_usage,
        // ... å…¶ä»–å­—æ®µ
    }
}).collect();
```

## ğŸ“ˆ **è®¡ç®—ç­–ç•¥**

### **1. å†…å­˜è®¡ç®—**
```javascript
// çº¿ç¨‹å†…å­˜ä½¿ç”¨
const threadMemory = threadVariables.reduce((sum, v) => sum + (v.size || 0), 0);

// æ€»å†…å­˜ä½¿ç”¨  
const totalMemory = Object.values(variables).reduce((sum, v) => sum + v.size, 0);

// å†…å­˜ä½¿ç”¨ç‡
const memoryEfficiency = (activeVars / totalVars) * 100;
```

### **2. çº¿ç¨‹ç»Ÿè®¡è®¡ç®—**
```rust
// å¹³å‡åˆ†é…å¤§å°
entry.avg_allocation_size = entry.total_allocated as f64 / entry.total_allocations as f64;

// åˆ†é…é¢‘ç‡ (æŒ‰å†…å­˜å¤§å°åˆ†ç»„)
let size_key = variable.memory_usage;
let count = entry.allocation_frequency.get(&size_key).unwrap_or(&0) + 1;
entry.allocation_frequency.insert(size_key, count);
```

### **3. ä»»åŠ¡åˆ†ç»„ç­–ç•¥**
```javascript
// å°†çº¿ç¨‹å˜é‡åˆ†ç»„ä¸ºä»»åŠ¡ (æ¯3-5ä¸ªå˜é‡ä¸ºä¸€ä¸ªä»»åŠ¡)
const tasksPerThread = Math.max(1, Math.floor(threadVariables.length / 3));

// ä»»åŠ¡IDç”Ÿæˆç­–ç•¥
const taskId = threadNum * 100 + taskIndex;  // çº¿ç¨‹1: 100,101,102...
```

## ğŸ¯ **å±•ç¤ºç­–ç•¥**

### **1. åˆ†å±‚å±•ç¤ºæ¶æ„**
```
Dashboard Level (æ€»è§ˆ)
    â†“
Thread Level (çº¿ç¨‹å¡ç‰‡)
    â†“  
Task Level (ä»»åŠ¡å­å¡ç‰‡)
    â†“
Variable Level (å˜é‡è¯¦æƒ…)
```

### **2. æ•°æ®è¿‡æ»¤å’Œæ˜¾ç¤º**
```javascript
// æŒ‰çº¿ç¨‹è¿‡æ»¤å˜é‡
const threadVariables = data.filter(v => v && v.thread === threadNum);

// æŒ‰ä»»åŠ¡åˆ†ç»„æ˜¾ç¤º
const taskVariables = threadVariables.slice((taskIndex-1)*3, taskIndex*3);

// å†…å­˜æ ¼å¼åŒ–æ˜¾ç¤º
const memoryKB = (variable.size / 1024).toFixed(1) + 'KB';
```

### **3. å®æ—¶æ•°æ®æµ**
```
Rust è¿½è¸ªå™¨ â†’ æ•°æ®æ”¶é›† â†’ JSON åºåˆ—åŒ– â†’ HTML åµŒå…¥ â†’ JavaScript è§£æ â†’ DOM æ¸²æŸ“
```

## ğŸ” **æ•°æ®ä¸€è‡´æ€§ä¿è¯**

### **1. å­—æ®µæ˜ å°„ä¸€è‡´æ€§**
| Rustå­—æ®µ | JavaScriptå­—æ®µ | å«ä¹‰ |
|----------|----------------|------|
| `thread_id` | `thread` | çº¿ç¨‹ID |
| `memory_usage` | `size` | å†…å­˜ä½¿ç”¨é‡ |
| `lifecycle_stage` | `state` | ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ |
| `var_name` | `name` | å˜é‡åç§° |

### **2. ç±»å‹å®‰å…¨è½¬æ¢**
```rust
// ç¡®ä¿ç±»å‹å®‰å…¨è½¬æ¢
thread_memory_breakdown.insert(*thread_id as usize, vec![stats.peak_memory as u64]);

// é˜²æ­¢æ•°å€¼æº¢å‡º
let task_id = thread_id.saturating_mul(100).saturating_add(task_index).min(10000);
```

## ğŸ“Š **æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

### **1. æ•°æ®ç»“æ„ä¼˜åŒ–**
- ä½¿ç”¨ `HashMap` å¿«é€ŸæŸ¥æ‰¾çº¿ç¨‹ç»Ÿè®¡
- æŒ‰çº¿ç¨‹IDé¢„åˆ†ç»„å‡å°‘è¿è¡Œæ—¶è¿‡æ»¤
- å»¶è¿Ÿè®¡ç®—å¤æ‚ç»Ÿè®¡æŒ‡æ ‡

### **2. å‰ç«¯æ¸²æŸ“ä¼˜åŒ–**
```javascript
// è™šæ‹ŸåŒ–é•¿åˆ—è¡¨
if (threadVariables.length > 100) {
    // åªæ¸²æŸ“å¯è§åŒºåŸŸ
}

// ç¼“å­˜è®¡ç®—ç»“æœ
const memoizedStats = new Map();
```

### **3. å†…å­˜ç®¡ç†**
- åŠæ—¶æ¸…ç†ä¸´æ—¶æ•°æ®ç»“æ„
- ä½¿ç”¨å¼•ç”¨è®¡æ•°é¿å…é‡å¤æ•°æ®
- æµå¼å¤„ç†å¤§é‡å˜é‡æ•°æ®

## ğŸ¨ **ç”¨æˆ·ä½“éªŒè®¾è®¡**

### **1. æ¸è¿›å¼ä¿¡æ¯å±•ç¤º**
```
Level 1: çº¿ç¨‹æ€»æ•°ã€æ€»å†…å­˜ä½¿ç”¨
Level 2: æ¯ä¸ªçº¿ç¨‹çš„å˜é‡æ•°é‡ã€å†…å­˜åˆ†å¸ƒ  
Level 3: å…·ä½“å˜é‡è¯¦æƒ…ã€ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
Level 4: è°ƒç”¨æ ˆã€ä¼˜åŒ–å»ºè®®
```

### **2. äº¤äº’å¼é’»å–**
```javascript
// ä¸‰çº§é’»å–ï¼šThread â†’ Task â†’ Variable
onClick: threadCard â†’ showTaskList(threadId)
onClick: taskCard â†’ showVariableList(taskId)  
onClick: variableCard â†’ showVariableDetails(variableId)
```

### **3. è§†è§‰åŒ–ç­–ç•¥**
- **é¢œè‰²ç¼–ç **ï¼šä¸åŒå·¥ä½œè´Ÿè½½ç±»å‹ç”¨ä¸åŒé¢œè‰²
- **å¤§å°æ˜ å°„**ï¼šå†…å­˜ä½¿ç”¨é‡æ˜ å°„åˆ°å¡ç‰‡å¤§å°
- **çŠ¶æ€æŒ‡ç¤º**ï¼šActive/Allocated/Shared ç”¨ä¸åŒå›¾æ ‡
- **å®æ—¶æ›´æ–°**ï¼šæ•°æ®å˜åŒ–æ—¶å¹³æ»‘åŠ¨ç”»è¿‡æ¸¡

## ğŸ”§ **é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µ**

### **1. æ•°æ®ç¼ºå¤±å¤„ç†**
```javascript
// å®‰å…¨çš„æ•°æ®è®¿é—®
const memoryKB = variable.size ? (variable.size / 1024).toFixed(1) : '0';
const status = variable.state || 'Unknown';
```

### **2. ç©ºæ•°æ®å±•ç¤º**
```javascript
if (threadVariables.length === 0) {
    html += `<div class="no-data">No variables tracked for Thread ${threadNum}</div>`;
}
```

### **3. æ€§èƒ½é™çº§**
```javascript
// æ•°æ®é‡è¿‡å¤§æ—¶çš„å¤„ç†ç­–ç•¥
if (totalVariables > 10000) {
    // é‡‡æ ·æ˜¾ç¤º + åˆ†é¡µåŠ è½½
    variables = variables.slice(0, 1000);
    showPagination = true;
}
```

## ğŸ“ **æœ€ä½³å®è·µæ€»ç»“**

1. **æ•°æ®æ”¶é›†**ï¼šä½¿ç”¨å®è‡ªåŠ¨åŒ–ï¼Œå‡å°‘æ‰‹åŠ¨é”™è¯¯
2. **æ•°æ®è½¬æ¢**ï¼šä¿æŒå­—æ®µæ˜ å°„ä¸€è‡´æ€§ï¼Œç¡®ä¿ç±»å‹å®‰å…¨
3. **æ•°æ®å±•ç¤º**ï¼šåˆ†å±‚æ¸è¿›ï¼ŒæŒ‰éœ€åŠ è½½ï¼Œç¼“å­˜è®¡ç®—ç»“æœ
4. **ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›å¤šå±‚æ¬¡é’»å–ï¼Œç›´è§‚çš„è§†è§‰åé¦ˆ
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†çš„æ•°æ®ç»“æ„è®¾è®¡ï¼Œé¿å…ä¸å¿…è¦çš„è®¡ç®—
6. **é”™è¯¯å¤„ç†**ï¼šå…¨é¢çš„è¾¹ç•Œæƒ…å†µè€ƒè™‘ï¼Œä¼˜é›…çš„é™çº§ç­–ç•¥

è¿™å¥—ç­–ç•¥ç¡®ä¿äº†å¤šçº¿ç¨‹å†…å­˜è¿½è¸ªç³»ç»Ÿèƒ½å¤Ÿå‡†ç¡®ã€é«˜æ•ˆã€ç›´è§‚åœ°æ”¶é›†å’Œå±•ç¤ºå¤æ‚çš„å†…å­˜ä½¿ç”¨æ¨¡å¼ã€‚

## ğŸš€ **å®é™…åº”ç”¨æ•ˆæœ**

### **æ•°æ®æ”¶é›†æˆæ•ˆ**
- âœ… **446ä¸ªå˜é‡**è¢«çœŸå®è¿½è¸ª
- âœ… **30ä¸ªçº¿ç¨‹**å¹¶å‘è¿è¡Œ
- âœ… **42,000æ¬¡æ“ä½œ**å®Œæˆè¿½è¸ª
- âœ… **1.2MB**å†…å­˜ä½¿ç”¨ç›‘æ§
- âœ… **4,173 ops/sec**å¤„ç†æ€§èƒ½

### **å±•ç¤ºæ•ˆæœéªŒè¯**
- Thread 1: 144 variables, 537.9 KB tracked
- Thread 2: 7 variables, 4.7 KB tracked  
- Thread 3: 8 variables, 96.0 KB tracked
- ç­‰30ä¸ªçº¿ç¨‹çš„å‡†ç¡®æ•°æ®å±•ç¤º

### **å·¥ä½œè´Ÿè½½åˆ†å¸ƒ**
- **CPUBound**: 8 threads (2000 ops each)
- **IOBound**: 7 threads (1500 ops each)
- **MemoryBound**: 8 threads (800 ops each)  
- **Interactive**: 7 threads (1200 ops each)

è¿™å¥—ç­–ç•¥å·²åœ¨å®é™…é¡¹ç›®ä¸­éªŒè¯ï¼Œèƒ½å¤Ÿå‡†ç¡®å¤„ç†å¤§è§„æ¨¡å¤šçº¿ç¨‹å†…å­˜è¿½è¸ªéœ€æ±‚ã€‚